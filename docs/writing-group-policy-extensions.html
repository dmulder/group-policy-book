<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>19 Writing Group Policy Extensions | Group Policy on Linux</title>
  <meta name="description" content="<p>This book introduces the user to opensource tools for managing Linux
clients via Group Policy.</p>" />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="19 Writing Group Policy Extensions | Group Policy on Linux" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://dmulder.github.io/group-policy-book/cover-image.png" />
  <meta property="og:description" content="<p>This book introduces the user to opensource tools for managing Linux
clients via Group Policy.</p>" />
  <meta name="github-repo" content="dmulder/group-policy-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="19 Writing Group Policy Extensions | Group Policy on Linux" />
  
  <meta name="twitter:description" content="<p>This book introduces the user to opensource tools for managing Linux
clients via Group Policy.</p>" />
  <meta name="twitter:image" content="https://dmulder.github.io/group-policy-book/cover-image.png" />

<meta name="author" content="David Mulder" />


<meta name="date" content="2022-12-16" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="firewalld.html"/>
<link rel="next" href="regpol.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i><b>1.1</b> About the Author</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#whats-the-difference-between-group-policy-and-a-group-policy-object"><i class="fa fa-check"></i><b>2.1</b> What’s the difference between Group Policy and a Group Policy Object?</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#server-side-extensions"><i class="fa fa-check"></i><b>2.2</b> Server Side Extensions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="intro.html"><a href="intro.html#enabling-group-policy-server-side-extensions-on-the-server"><i class="fa fa-check"></i><b>2.2.1</b> Enabling Group Policy Server Side Extensions on the Server</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#client-side-extensions"><i class="fa fa-check"></i><b>2.3</b> Client Side Extensions</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="intro.html"><a href="intro.html#enabling-group-policy-client-side-extensions-on-the-linux-client"><i class="fa fa-check"></i><b>2.3.1</b> Enabling Group Policy Client Side Extensions on the Linux Client</a></li>
<li class="chapter" data-level="2.3.2" data-path="intro.html"><a href="intro.html#rsop"><i class="fa fa-check"></i><b>2.3.2</b> Resultant Set of Policy</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#policies-introduced-in-this-book"><i class="fa fa-check"></i><b>2.4</b> Policies Introduced in this Book</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="intro.html"><a href="intro.html#smb.conf-policies"><i class="fa fa-check"></i><b>2.4.1</b> smb.conf Policies</a></li>
<li class="chapter" data-level="2.4.2" data-path="intro.html"><a href="intro.html#password-and-kerberos-policies"><i class="fa fa-check"></i><b>2.4.2</b> Password and Kerberos Policies</a></li>
<li class="chapter" data-level="2.4.3" data-path="intro.html"><a href="intro.html#script-policies"><i class="fa fa-check"></i><b>2.4.3</b> Script Policies</a></li>
<li class="chapter" data-level="2.4.4" data-path="intro.html"><a href="intro.html#startup-script-policies"><i class="fa fa-check"></i><b>2.4.4</b> Startup Script Policies</a></li>
<li class="chapter" data-level="2.4.5" data-path="intro.html"><a href="intro.html#files-policy"><i class="fa fa-check"></i><b>2.4.5</b> Files Policy</a></li>
<li class="chapter" data-level="2.4.6" data-path="intro.html"><a href="intro.html#symlink-policies"><i class="fa fa-check"></i><b>2.4.6</b> Symlink Policies</a></li>
<li class="chapter" data-level="2.4.7" data-path="intro.html"><a href="intro.html#sudoers-policies"><i class="fa fa-check"></i><b>2.4.7</b> Sudoers Policies</a></li>
<li class="chapter" data-level="2.4.8" data-path="intro.html"><a href="intro.html#message-policies"><i class="fa fa-check"></i><b>2.4.8</b> Message Policies</a></li>
<li class="chapter" data-level="2.4.9" data-path="intro.html"><a href="intro.html#pam-access-policies"><i class="fa fa-check"></i><b>2.4.9</b> PAM Access Policies</a></li>
<li class="chapter" data-level="2.4.10" data-path="intro.html"><a href="intro.html#certificate-auto-enrollment"><i class="fa fa-check"></i><b>2.4.10</b> Certificate Auto Enrollment</a></li>
<li class="chapter" data-level="2.4.11" data-path="intro.html"><a href="intro.html#firefox-policy"><i class="fa fa-check"></i><b>2.4.11</b> Firefox Policy</a></li>
<li class="chapter" data-level="2.4.12" data-path="intro.html"><a href="intro.html#chromiumchrome-policy"><i class="fa fa-check"></i><b>2.4.12</b> Chromium/Chrome Policy</a></li>
<li class="chapter" data-level="2.4.13" data-path="intro.html"><a href="intro.html#gnome-settings"><i class="fa fa-check"></i><b>2.4.13</b> GNOME Settings</a></li>
<li class="chapter" data-level="2.4.14" data-path="intro.html"><a href="intro.html#openssh-policy"><i class="fa fa-check"></i><b>2.4.14</b> OpenSSH Policy</a></li>
<li class="chapter" data-level="2.4.15" data-path="intro.html"><a href="intro.html#firewalld-policy"><i class="fa fa-check"></i><b>2.4.15</b> Firewalld Policy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="manage.html"><a href="manage.html"><i class="fa fa-check"></i><b>3</b> Managing Group Policies</a>
<ul>
<li class="chapter" data-level="3.1" data-path="manage.html"><a href="manage.html#gpopen"><i class="fa fa-check"></i><b>3.1</b> Opening a Group Policy Object in the Group Policy Management Console</a></li>
<li class="chapter" data-level="3.2" data-path="manage.html"><a href="manage.html#gpcreate"><i class="fa fa-check"></i><b>3.2</b> Creating a Group Policy Object</a></li>
<li class="chapter" data-level="3.3" data-path="manage.html"><a href="manage.html#gpdelete"><i class="fa fa-check"></i><b>3.3</b> Deleting a Group Policy Object</a></li>
<li class="chapter" data-level="3.4" data-path="manage.html"><a href="manage.html#gplist"><i class="fa fa-check"></i><b>3.4</b> Listing a Group Policy</a></li>
<li class="chapter" data-level="3.5" data-path="manage.html"><a href="manage.html#gpmodify"><i class="fa fa-check"></i><b>3.5</b> Modifying a Group Policy</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="smbconf.html"><a href="smbconf.html"><i class="fa fa-check"></i><b>4</b> smb.conf Policies</a>
<ul>
<li class="chapter" data-level="4.1" data-path="smbconf.html"><a href="smbconf.html#smbconf-sse"><i class="fa fa-check"></i><b>4.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="smbconf.html"><a href="smbconf.html#managing-smb.conf-policies-via-the-gpme"><i class="fa fa-check"></i><b>4.1.1</b> Managing smb.conf Policies via the GPME</a></li>
<li class="chapter" data-level="4.1.2" data-path="smbconf.html"><a href="smbconf.html#managing-smb.conf-policies-via-samba-tool"><i class="fa fa-check"></i><b>4.1.2</b> Managing smb.conf Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="smbconf.html"><a href="smbconf.html#client-side-extension"><i class="fa fa-check"></i><b>4.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sec.html"><a href="sec.html"><i class="fa fa-check"></i><b>5</b> Password and Kerberos Policies</a>
<ul>
<li class="chapter" data-level="5.1" data-path="sec.html"><a href="sec.html#server-side-extension"><i class="fa fa-check"></i><b>5.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="sec.html"><a href="sec.html#managing-password-and-kerberos-policies-via-the-gpme"><i class="fa fa-check"></i><b>5.1.1</b> Managing Password and Kerberos Policies via the GPME</a></li>
<li class="chapter" data-level="5.1.2" data-path="sec.html"><a href="sec.html#managing-password-and-kerberos-policies-via-samba-tool"><i class="fa fa-check"></i><b>5.1.2</b> Managing Password and Kerberos Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="sec.html"><a href="sec.html#client-side-extension-1"><i class="fa fa-check"></i><b>5.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="scripts.html"><a href="scripts.html"><i class="fa fa-check"></i><b>6</b> Script Policies</a>
<ul>
<li class="chapter" data-level="6.1" data-path="scripts.html"><a href="scripts.html#server-side-extension-1"><i class="fa fa-check"></i><b>6.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="scripts.html"><a href="scripts.html#scripts-gpme"><i class="fa fa-check"></i><b>6.1.1</b> Managing Machine Scripts Policies via the GPME</a></li>
<li class="chapter" data-level="6.1.2" data-path="scripts.html"><a href="scripts.html#managing-user-scripts-policies-via-the-gpme"><i class="fa fa-check"></i><b>6.1.2</b> Managing User Scripts Policies via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="scripts.html"><a href="scripts.html#client-side-extension-2"><i class="fa fa-check"></i><b>6.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="startupscripts.html"><a href="startupscripts.html"><i class="fa fa-check"></i><b>7</b> Startup Script Policies</a>
<ul>
<li class="chapter" data-level="7.1" data-path="startupscripts.html"><a href="startupscripts.html#server-side-extension-2"><i class="fa fa-check"></i><b>7.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="startupscripts.html"><a href="startupscripts.html#managing-startup-script-policies-via-samba-tool"><i class="fa fa-check"></i><b>7.1.1</b> Managing Startup Script Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="startupscripts.html"><a href="startupscripts.html#client-side-extension-3"><i class="fa fa-check"></i><b>7.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="files.html"><a href="files.html"><i class="fa fa-check"></i><b>8</b> Files Policy</a>
<ul>
<li class="chapter" data-level="8.1" data-path="files.html"><a href="files.html#server-side-extension-3"><i class="fa fa-check"></i><b>8.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="files.html"><a href="files.html#managing-the-files-policy-via-samba-tool"><i class="fa fa-check"></i><b>8.1.1</b> Managing the Files Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="files.html"><a href="files.html#client-side-extension-4"><i class="fa fa-check"></i><b>8.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="symlink.html"><a href="symlink.html"><i class="fa fa-check"></i><b>9</b> Symlink Policies</a>
<ul>
<li class="chapter" data-level="9.1" data-path="symlink.html"><a href="symlink.html#server-side-extension-4"><i class="fa fa-check"></i><b>9.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="symlink.html"><a href="symlink.html#managing-the-symlink-policy-via-samba-tool"><i class="fa fa-check"></i><b>9.1.1</b> Managing the Symlink Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="symlink.html"><a href="symlink.html#client-side-extension-5"><i class="fa fa-check"></i><b>9.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="sudoers.html"><a href="sudoers.html"><i class="fa fa-check"></i><b>10</b> Sudoers Policies</a>
<ul>
<li class="chapter" data-level="10.1" data-path="sudoers.html"><a href="sudoers.html#server-side-extension-5"><i class="fa fa-check"></i><b>10.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="sudoers.html"><a href="sudoers.html#sudoers-gpme"><i class="fa fa-check"></i><b>10.1.1</b> Managing Sudoers Policy via the GPME</a></li>
<li class="chapter" data-level="10.1.2" data-path="sudoers.html"><a href="sudoers.html#sudoers-samba-tool"><i class="fa fa-check"></i><b>10.1.2</b> Managing Sudoers Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="sudoers.html"><a href="sudoers.html#client-side-extension-6"><i class="fa fa-check"></i><b>10.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="msgs.html"><a href="msgs.html"><i class="fa fa-check"></i><b>11</b> Message Policies</a>
<ul>
<li class="chapter" data-level="11.1" data-path="msgs.html"><a href="msgs.html#server-side-extension-6"><i class="fa fa-check"></i><b>11.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="msgs.html"><a href="msgs.html#msgs-gpme"><i class="fa fa-check"></i><b>11.1.1</b> Managing Message Policy via the GPME</a></li>
<li class="chapter" data-level="11.1.2" data-path="msgs.html"><a href="msgs.html#msgs-samba-tool"><i class="fa fa-check"></i><b>11.1.2</b> Managing Message Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="msgs.html"><a href="msgs.html#client-side-extension-7"><i class="fa fa-check"></i><b>11.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="pamaccess.html"><a href="pamaccess.html"><i class="fa fa-check"></i><b>12</b> PAM Access Policies</a>
<ul>
<li class="chapter" data-level="12.1" data-path="pamaccess.html"><a href="pamaccess.html#server-side-extension-7"><i class="fa fa-check"></i><b>12.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="pamaccess.html"><a href="pamaccess.html#managing-pam-access-policies-via-samba-tool"><i class="fa fa-check"></i><b>12.1.1</b> Managing PAM Access Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="pamaccess.html"><a href="pamaccess.html#client-side-extension-8"><i class="fa fa-check"></i><b>12.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="certautoenroll.html"><a href="certautoenroll.html"><i class="fa fa-check"></i><b>13</b> Certificate Auto Enrollment Policy</a>
<ul>
<li class="chapter" data-level="13.1" data-path="certautoenroll.html"><a href="certautoenroll.html#server-side-extension-8"><i class="fa fa-check"></i><b>13.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="certautoenroll.html"><a href="certautoenroll.html#managing-certificate-auto-enrollment-via-the-gpme"><i class="fa fa-check"></i><b>13.1.1</b> Managing Certificate Auto Enrollment via the GPME</a></li>
<li class="chapter" data-level="13.1.2" data-path="certautoenroll.html"><a href="certautoenroll.html#certificate-templates"><i class="fa fa-check"></i><b>13.1.2</b> Certificate Templates</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="certautoenroll.html"><a href="certautoenroll.html#client-side-extension-9"><i class="fa fa-check"></i><b>13.2</b> Client Side Extension</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="certautoenroll.html"><a href="certautoenroll.html#trouble-shooting-certificates"><i class="fa fa-check"></i><b>13.2.1</b> Trouble Shooting Certificates</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="firefox.html"><a href="firefox.html"><i class="fa fa-check"></i><b>14</b> Firefox Policy</a>
<ul>
<li class="chapter" data-level="14.1" data-path="firefox.html"><a href="firefox.html#server-side-extension-9"><i class="fa fa-check"></i><b>14.1</b> Server Side Extension</a></li>
<li class="chapter" data-level="14.2" data-path="firefox.html"><a href="firefox.html#managing-firefox-policy-via-the-gpme"><i class="fa fa-check"></i><b>14.2</b> Managing Firefox Policy via the GPME</a></li>
<li class="chapter" data-level="14.3" data-path="firefox.html"><a href="firefox.html#client-side-extension-10"><i class="fa fa-check"></i><b>14.3</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="chrome.html"><a href="chrome.html"><i class="fa fa-check"></i><b>15</b> Chromium/Chrome Policy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="chrome.html"><a href="chrome.html#server-side-extension-10"><i class="fa fa-check"></i><b>15.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="chrome.html"><a href="chrome.html#managing-chromium-policy-via-the-gpme"><i class="fa fa-check"></i><b>15.1.1</b> Managing Chromium Policy via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="chrome.html"><a href="chrome.html#client-side-extension-11"><i class="fa fa-check"></i><b>15.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="gnome.html"><a href="gnome.html"><i class="fa fa-check"></i><b>16</b> GNOME Settings Policy</a>
<ul>
<li class="chapter" data-level="16.1" data-path="gnome.html"><a href="gnome.html#server-side-extension-11"><i class="fa fa-check"></i><b>16.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="gnome.html"><a href="gnome.html#managing-gnome-settings-policy-via-the-gpme"><i class="fa fa-check"></i><b>16.1.1</b> Managing GNOME Settings Policy via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="gnome.html"><a href="gnome.html#client-side-extension-12"><i class="fa fa-check"></i><b>16.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="openssh.html"><a href="openssh.html"><i class="fa fa-check"></i><b>17</b> OpenSSH Policy</a>
<ul>
<li class="chapter" data-level="17.1" data-path="openssh.html"><a href="openssh.html#server-side-extension-12"><i class="fa fa-check"></i><b>17.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="openssh.html"><a href="openssh.html#managing-openssh-policy-via-samba-tool"><i class="fa fa-check"></i><b>17.1.1</b> Managing OpenSSH Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="openssh.html"><a href="openssh.html#client-side-extension-13"><i class="fa fa-check"></i><b>17.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="firewalld.html"><a href="firewalld.html"><i class="fa fa-check"></i><b>18</b> Firewalld Policy</a>
<ul>
<li class="chapter" data-level="18.1" data-path="firewalld.html"><a href="firewalld.html#server-side-extension-13"><i class="fa fa-check"></i><b>18.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="firewalld.html"><a href="firewalld.html#managing-firewalld-policy-via-the-gpme"><i class="fa fa-check"></i><b>18.1.1</b> Managing Firewalld Policy via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="firewalld.html"><a href="firewalld.html#client-side-extension-14"><i class="fa fa-check"></i><b>18.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html"><i class="fa fa-check"></i><b>19</b> Writing Group Policy Extensions</a>
<ul>
<li class="chapter" data-level="19.1" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#sse"><i class="fa fa-check"></i><b>19.1</b> Creating the Server Side Extension</a>
<ul>
<li class="chapter" data-level="19.1.1" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#admx"><i class="fa fa-check"></i><b>19.1.1</b> Administrative Templates</a></li>
<li class="chapter" data-level="19.1.2" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#samba-tool-gpo-manage"><i class="fa fa-check"></i><b>19.1.2</b> samba-tool gpo manage</a></li>
</ul></li>
<li class="chapter" data-level="19.2" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#cse"><i class="fa fa-check"></i><b>19.2</b> Creating the Client Side Extension</a>
<ul>
<li class="chapter" data-level="19.2.1" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#the-gp_pol_extgp_inf_ext-python-classes"><i class="fa fa-check"></i><b>19.2.1</b> The gp_pol_ext/gp_inf_ext Python Classes</a></li>
<li class="chapter" data-level="19.2.2" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#process-group-policy"><i class="fa fa-check"></i><b>19.2.2</b> Process Group Policy</a></li>
<li class="chapter" data-level="19.2.3" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#deleted-gpos"><i class="fa fa-check"></i><b>19.2.3</b> Deleted GPOs</a></li>
<li class="chapter" data-level="19.2.4" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#changed-gpos"><i class="fa fa-check"></i><b>19.2.4</b> Changed GPOs</a></li>
<li class="chapter" data-level="19.2.5" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#resultant-set-of-policy"><i class="fa fa-check"></i><b>19.2.5</b> Resultant Set of Policy</a></li>
<li class="chapter" data-level="19.2.6" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#registeringunregistering-a-client-side-extension"><i class="fa fa-check"></i><b>19.2.6</b> Registering/Unregistering a Client Side Extension</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="regpol.html"><a href="regpol.html"><i class="fa fa-check"></i><b>20</b> Modifying a Registry.pol File</a>
<ul>
<li class="chapter" data-level="20.1" data-path="regpol.html"><a href="regpol.html#using-samba-tool"><i class="fa fa-check"></i><b>20.1</b> Using samba-tool</a></li>
<li class="chapter" data-level="20.2" data-path="regpol.html"><a href="regpol.html#scripting-with-python"><i class="fa fa-check"></i><b>20.2</b> Scripting with python</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="install-admx.html"><a href="install-admx.html"><i class="fa fa-check"></i><b>21</b> Installing Administrative Templates</a>
<ul>
<li class="chapter" data-level="21.1" data-path="install-admx.html"><a href="install-admx.html#install-admx-samba"><i class="fa fa-check"></i><b>21.1</b> Install Samba ADMX Templates</a></li>
<li class="chapter" data-level="21.2" data-path="install-admx.html"><a href="install-admx.html#install-admx-firefox"><i class="fa fa-check"></i><b>21.2</b> Installing Firefox ADMX Templates</a></li>
<li class="chapter" data-level="21.3" data-path="install-admx.html"><a href="install-admx.html#install-admx-chromium"><i class="fa fa-check"></i><b>21.3</b> Installing Chromium ADMX Templates</a></li>
<li class="chapter" data-level="21.4" data-path="install-admx.html"><a href="install-admx.html#install-admx-windows"><i class="fa fa-check"></i><b>21.4</b> Installing Windows ADMX Templates</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Group Policy on Linux</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="writing-group-policy-extensions" class="section level1 hasAnchor" number="19">
<h1><span class="header-section-number">19</span> Writing Group Policy Extensions<a href="writing-group-policy-extensions.html#writing-group-policy-extensions" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The chapter will explain how to write a Group Policy Extension for Samba’s Winbind. Group Policy is a delivery mechanism for distributing system settings and company policies to machines joined to an Active Directory domain. Unix/Linux machines running Samba’s Winbind can also deploy these policies.</p>
<div id="sse" class="section level2 hasAnchor" number="19.1">
<h2><span class="header-section-number">19.1</span> Creating the Server Side Extension<a href="writing-group-policy-extensions.html#sse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="admx" class="section level3 hasAnchor" number="19.1.1">
<h3><span class="header-section-number">19.1.1</span> Administrative Templates<a href="writing-group-policy-extensions.html#admx" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first step to deploying Group Policy is to create a Server Side Extension (SSE). There are multiple ways to create an SSE, but here we’ll only discuss Administrative Templates (ADMX). The purpose of the SSE is to deploy policies to the SYSVOL share. Theoretically, you could manually deploy any file (even plain text) to the SYSVOL and then write a Client Side Extension that parses it, but ADMX can be read and modified by the Group Policy Management Editor, which makes administration of policies simpler.</p>
<p>ADMX files are simply XML files which explain to the Group Policy Management Console how to display and store a policy in the SYSVOL. AMDX files always store policies in Registry.pol files. Samba provides a mechanism for parsing these, which we’ll discuss later.</p>
<p>Below is a simple example of an ADMX template, and it’s corresponding ADML file.</p>
<p><strong>samba.admx:</strong></p>
<div class="sourceCode" id="cb100"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb100-1"><a href="writing-group-policy-extensions.html#cb100-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">policyDefinitions</span><span class="ot"> revision=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> schemaVersion=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb100-2"><a href="writing-group-policy-extensions.html#cb100-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">policyNamespaces</span>&gt;</span>
<span id="cb100-3"><a href="writing-group-policy-extensions.html#cb100-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">target</span><span class="ot"> prefix=</span><span class="st">&quot;fullarmor&quot;</span><span class="ot"> namespace=</span><span class="st">&quot;FullArmor.Policies.98BB16AF_01EE_4D17_870D_A3311A44D6C2&quot;</span> /&gt;</span>
<span id="cb100-4"><a href="writing-group-policy-extensions.html#cb100-4" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">using</span><span class="ot"> prefix=</span><span class="st">&quot;windows&quot;</span><span class="ot"> namespace=</span><span class="st">&quot;Microsoft.Policies.Windows&quot;</span> /&gt;</span>
<span id="cb100-5"><a href="writing-group-policy-extensions.html#cb100-5" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">policyNamespaces</span>&gt;</span>
<span id="cb100-6"><a href="writing-group-policy-extensions.html#cb100-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">supersededAdm</span><span class="ot"> fileName=</span><span class="st">&quot;&quot;</span> /&gt;</span>
<span id="cb100-7"><a href="writing-group-policy-extensions.html#cb100-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">resources</span><span class="ot"> minRequiredRevision=</span><span class="st">&quot;1.0&quot;</span> /&gt;</span>
<span id="cb100-8"><a href="writing-group-policy-extensions.html#cb100-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">categories</span>&gt;</span>
<span id="cb100-9"><a href="writing-group-policy-extensions.html#cb100-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">category</span><span class="ot"> name=</span><span class="st">&quot;CAT_3338C1DD_8A00_4273_8547_158D8B8C19E9&quot;</span><span class="ot"> displayName=</span><span class="st">&quot;$(string.CAT_3338C1DD_8A00_4273_8547_158D8</span></span>
<span id="cb100-10"><a href="writing-group-policy-extensions.html#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="st">B8C19E9)&quot;</span> /&gt;</span>
<span id="cb100-11"><a href="writing-group-policy-extensions.html#cb100-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">category</span><span class="ot"> name=</span><span class="st">&quot;CAT_7D8D7DC8_5A9D_4BE1_8227_F09CDD5AFFC6&quot;</span><span class="ot"> displayName=</span><span class="st">&quot;$(string.CAT_7D8D7DC8_5A9D_4BE1_8227_F09CD</span></span>
<span id="cb100-12"><a href="writing-group-policy-extensions.html#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="st">D5AFFC6)&quot;</span>&gt;</span>
<span id="cb100-13"><a href="writing-group-policy-extensions.html#cb100-13" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">parentCategory</span><span class="ot"> ref=</span><span class="st">&quot;CAT_3338C1DD_8A00_4273_8547_158D8B8C19E9&quot;</span> /&gt;</span>
<span id="cb100-14"><a href="writing-group-policy-extensions.html#cb100-14" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">category</span>&gt;</span>
<span id="cb100-15"><a href="writing-group-policy-extensions.html#cb100-15" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">categories</span>&gt;</span>
<span id="cb100-16"><a href="writing-group-policy-extensions.html#cb100-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">policies</span>&gt;</span>
<span id="cb100-17"><a href="writing-group-policy-extensions.html#cb100-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">policy</span><span class="ot"> name=</span><span class="st">&quot;POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061&quot;</span><span class="ot"> class=</span><span class="st">&quot;Machine&quot;</span><span class="ot"> displayName=</span><span class="st">&quot;$(string.POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061)&quot;</span><span class="ot"> explainText=</span><span class="st">&quot;$(string.POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061_Help)&quot;</span><span class="ot"> presentation=</span><span class="st">&quot;$(presentation.POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061)&quot;</span><span class="ot"> key=</span><span class="st">&quot;Software\Policies\Samba\Unix Settings&quot;</span>&gt;</span>
<span id="cb100-18"><a href="writing-group-policy-extensions.html#cb100-18" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">parentCategory</span><span class="ot"> ref=</span><span class="st">&quot;CAT_7D8D7DC8_5A9D_4BE1_8227_F09CDD5AFFC6&quot;</span> /&gt;</span>
<span id="cb100-19"><a href="writing-group-policy-extensions.html#cb100-19" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">supportedOn</span><span class="ot"> ref=</span><span class="st">&quot;windows:SUPPORTED_WindowsVista&quot;</span> /&gt;</span>
<span id="cb100-20"><a href="writing-group-policy-extensions.html#cb100-20" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">elements</span>&gt;</span>
<span id="cb100-21"><a href="writing-group-policy-extensions.html#cb100-21" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">list</span><span class="ot"> id=</span><span class="st">&quot;LST_2E9A4684_3C0E_415B_8FD6_D4AF68BC8AC6&quot;</span><span class="ot"> key=</span><span class="st">&quot;Software\Policies\Samba\Unix Settings\Daily Scripts&quot;</span><span class="ot"> valueName=</span><span class="st">&quot;Daily Scripts&quot;</span> /&gt;</span>
<span id="cb100-22"><a href="writing-group-policy-extensions.html#cb100-22" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">elements</span>&gt;</span>
<span id="cb100-23"><a href="writing-group-policy-extensions.html#cb100-23" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">policy</span>&gt;</span>
<span id="cb100-24"><a href="writing-group-policy-extensions.html#cb100-24" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">policies</span>&gt;</span>
<span id="cb100-25"><a href="writing-group-policy-extensions.html#cb100-25" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">policyDefinitions</span>&gt;</span></code></pre></div>
<p><strong>en-US/samba.adml:</strong></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb101-1"><a href="writing-group-policy-extensions.html#cb101-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">policyDefinitionResources</span><span class="ot"> revision=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> schemaVersion=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb101-2"><a href="writing-group-policy-extensions.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">displayName</span>&gt;</span>
<span id="cb101-3"><a href="writing-group-policy-extensions.html#cb101-3" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">displayName</span>&gt;</span>
<span id="cb101-4"><a href="writing-group-policy-extensions.html#cb101-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">description</span>&gt;</span>
<span id="cb101-5"><a href="writing-group-policy-extensions.html#cb101-5" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">description</span>&gt;</span>
<span id="cb101-6"><a href="writing-group-policy-extensions.html#cb101-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">resources</span>&gt;</span>
<span id="cb101-7"><a href="writing-group-policy-extensions.html#cb101-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">stringTable</span>&gt;</span>
<span id="cb101-8"><a href="writing-group-policy-extensions.html#cb101-8" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;CAT_3338C1DD_8A00_4273_8547_158D8B8C19E9&quot;</span>&gt;Samba&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb101-9"><a href="writing-group-policy-extensions.html#cb101-9" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;CAT_7D8D7DC8_5A9D_4BE1_8227_F09CDD5AFFC6&quot;</span>&gt;Unix Settings&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb101-10"><a href="writing-group-policy-extensions.html#cb101-10" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061&quot;</span>&gt;Daily Scripts&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb101-11"><a href="writing-group-policy-extensions.html#cb101-11" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061_Help&quot;</span>&gt;This policy setting allows you to execute commands, </span>
<span id="cb101-12"><a href="writing-group-policy-extensions.html#cb101-12" aria-hidden="true" tabindex="-1"></a>either local or on remote storage, daily.&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb101-13"><a href="writing-group-policy-extensions.html#cb101-13" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">stringTable</span>&gt;</span>
<span id="cb101-14"><a href="writing-group-policy-extensions.html#cb101-14" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">presentationTable</span>&gt;</span>
<span id="cb101-15"><a href="writing-group-policy-extensions.html#cb101-15" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">presentation</span><span class="ot"> id=</span><span class="st">&quot;POL_9320E11F_AC80_4A7D_A5C8_1C0F3F727061&quot;</span>&gt;</span>
<span id="cb101-16"><a href="writing-group-policy-extensions.html#cb101-16" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">listBox</span><span class="ot"> refId=</span><span class="st">&quot;LST_2E9A4684_3C0E_415B_8FD6_D4AF68BC8AC6&quot;</span>&gt;Script and arguments&lt;/<span class="kw">listBox</span>&gt;</span>
<span id="cb101-17"><a href="writing-group-policy-extensions.html#cb101-17" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">presentation</span>&gt;</span>
<span id="cb101-18"><a href="writing-group-policy-extensions.html#cb101-18" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">presentationTable</span>&gt;</span>
<span id="cb101-19"><a href="writing-group-policy-extensions.html#cb101-19" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">resources</span>&gt;</span>
<span id="cb101-20"><a href="writing-group-policy-extensions.html#cb101-20" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">policyDefinitionResources</span>&gt;</span></code></pre></div>
<p>The meaning of the various tags are explained in Microsoft’s Group Policy documentation at <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/admx-schema" class="uri">https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/admx-schema</a>. Before the endless documentation and confusing XML scares you away, be aware there is an easier way!</p>
<div id="admx-migrator" class="section level4 hasAnchor" number="19.1.1.1">
<h4><span class="header-section-number">19.1.1.1</span> ADMX Migrator<a href="writing-group-policy-extensions.html#admx-migrator" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>FullArmor created the ADMX Migrator to simplify the shift for system administrators from the old ADM policy templates to ADMX. Fortunately, this tool also serves our purpose for assisting us in easily creating these templates for our SSE. Unfortunately, the tool hasn’t seen any development in the past 8 years, and wont run in Windows 10 (or any Unix/Linux platform, for that matter). I had to dredge up a Windows 7 VM in order to install and use the tool.</p>
<div id="creating-the-administrative-template" class="section level5 hasAnchor" number="19.1.1.1.1">
<h5><span class="header-section-number">19.1.1.1.1</span> Creating the Administrative Template<a href="writing-group-policy-extensions.html#creating-the-administrative-template" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ol style="list-style-type: decimal">
<li><p>Open ADMX Migrator</p></li>
<li><p>Right click on ADMX Templates in the left tree view, and click New Template.</p></li>
<li><p>Give your template a name, and click OK.</p></li>
<li><p>Right click on the new template in the left tree view, and click New Category.</p></li>
</ol>
<p><img src="ext-images/new-category.png" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Give the Category a name. This name will be displayed in the Group Policy Management Editor under Administrative Templates. You can choose to nest template under an existing category, or simply add it as a new root.</li>
</ol>
<div id="info" style="color: green;">
<p>Note: You can also add sub-categories under this category. After clicking OK, right click the category you created and select New Category.</p>
</div>
<ol start="6" style="list-style-type: decimal">
<li>Next, create your policy by right clicking on your new category, and selecting New Policy Setting.</li>
</ol>
<p><img src="ext-images/new-policy.png" /></p>
<ol start="7" style="list-style-type: decimal">
<li><p>Because we’ll be applying these settings to a Linux machine, the Registry fields are mostly meaningless, but they are required. Your policies will be stored under these keys on the SYSVOL in the Registry.pol file. Choose some sensible Registry Key, such as ‘Software\Policies\Samba\Unix Settings’, and a Registry Value Name, such as ‘Daily Scripts’ (these are the values used for Samba’s cron.daily policy). The Display Name is the name that will be displayed for this policy in the Group Policy Management Editor. I usually make this the same as the Registry Value Name, but it doesn’t need to be.</p></li>
<li><p>Select whether this policy will be applied to a Machine, a User, or to Both in the Class field. In our example, we could potentially set Both, then our Client Side Extension would need to handle both cron.daily scripts (the Machine) and also User crontab entries. Click OK for your policy to be created.</p></li>
<li><p>Your new policy will appear in the middle list view. Highlight it, and you will see a number of tabs below for configuring the policy.</p></li>
</ol>
<p><img src="ext-images/new-policy-list-view.png" /></p>
<ol start="10" style="list-style-type: decimal">
<li><p>Select the Values tab and set the Enabled Value Type. In this case, we’ll use String, since our cron commands will be saved to the Registry.pol as a string. In the Value field, you can set a default enabled value (this is optional).</p></li>
<li><p>Select the Presentation tab, right click in the Elements view, and click New Element &gt; ListBox (or a different presentation, depending on the policy). If you look at the samba.adml file from the previous section, you’ll notice that the presentationTable contains a listBox item. That’s what we’re creating here.</p></li>
<li><p>Choose an element Label, this will be the name for the list displayed in the Group Policy Management Editor.</p></li>
<li><p>Choose a Registry Key. This will be pre-populated with the parent Registry Key you gave when creating the policy. Append something to the key to make it unique. We’ll use ‘Software\Policies\Samba\Unix Settings\Daily Scripts’ for our cron.daily policy.</p></li>
<li><p>Navigate to the Explain tab, and add an explanation of what this policy is and what it does. This will be displayed to users in the Group Policy Management Editor.</p></li>
<li><p>Now right click on your template name in the left tree, and select Save As.</p></li>
<li><p>Finally, you’ll need to deploy your new policy definition to the SYSVOL. It should be saved to the Policies\PolicyDefinitions (the Group Policy Central Store) directory. These instructions from Microsoft can assist you in setting up your Group Policy Central Store.</p></li>
</ol>
<p><img src="ext-images/sse.png" /></p>
</div>
</div>
</div>
<div id="samba-tool-gpo-manage" class="section level3 hasAnchor" number="19.1.2">
<h3><span class="header-section-number">19.1.2</span> samba-tool gpo manage<a href="writing-group-policy-extensions.html#samba-tool-gpo-manage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
</div>
</div>
<div id="cse" class="section level2 hasAnchor" number="19.2">
<h2><span class="header-section-number">19.2</span> Creating the Client Side Extension<a href="writing-group-policy-extensions.html#cse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The Client Side Extension (CSE) is the code that will be called by Samba’s Winbind to deploy our newly created policy to a client machine. CSEs must be written in Python3, and are deployed using the <code>register_gp_extension()</code> and <code>unregister_gp_extension()</code> samba functions.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="writing-group-policy-extensions.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python3</span></span>
<span id="cb102-2"><a href="writing-group-policy-extensions.html#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="co"># gp_scripts_ext samba gpo policy</span></span>
<span id="cb102-3"><a href="writing-group-policy-extensions.html#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Copyright (C) David Mulder &lt;dmulder@suse.com&gt; 2020</span></span>
<span id="cb102-4"><a href="writing-group-policy-extensions.html#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb102-5"><a href="writing-group-policy-extensions.html#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This program is free software; you can redistribute it and/or modify</span></span>
<span id="cb102-6"><a href="writing-group-policy-extensions.html#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># it under the terms of the GNU General Public License as published by</span></span>
<span id="cb102-7"><a href="writing-group-policy-extensions.html#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co"># the Free Software Foundation; either version 3 of the License, or</span></span>
<span id="cb102-8"><a href="writing-group-policy-extensions.html#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="co"># (at your option) any later version.</span></span>
<span id="cb102-9"><a href="writing-group-policy-extensions.html#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb102-10"><a href="writing-group-policy-extensions.html#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="co"># This program is distributed in the hope that it will be useful,</span></span>
<span id="cb102-11"><a href="writing-group-policy-extensions.html#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="co"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span>
<span id="cb102-12"><a href="writing-group-policy-extensions.html#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="co"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span>
<span id="cb102-13"><a href="writing-group-policy-extensions.html#cb102-13" aria-hidden="true" tabindex="-1"></a><span class="co"># GNU General Public License for more details.</span></span>
<span id="cb102-14"><a href="writing-group-policy-extensions.html#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb102-15"><a href="writing-group-policy-extensions.html#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="co"># You should have received a copy of the GNU General Public License</span></span>
<span id="cb102-16"><a href="writing-group-policy-extensions.html#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="co"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span>
<span id="cb102-17"><a href="writing-group-policy-extensions.html#cb102-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-18"><a href="writing-group-policy-extensions.html#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, re</span>
<span id="cb102-19"><a href="writing-group-policy-extensions.html#cb102-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> samba.gpclass <span class="im">import</span> gp_pol_ext, register_gp_extension, <span class="op">\</span></span>
<span id="cb102-20"><a href="writing-group-policy-extensions.html#cb102-20" aria-hidden="true" tabindex="-1"></a>    unregister_gp_extension, list_gp_extensions</span>
<span id="cb102-21"><a href="writing-group-policy-extensions.html#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> base64 <span class="im">import</span> b64encode</span>
<span id="cb102-22"><a href="writing-group-policy-extensions.html#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tempfile <span class="im">import</span> NamedTemporaryFile</span>
<span id="cb102-23"><a href="writing-group-policy-extensions.html#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> samba <span class="im">import</span> getopt <span class="im">as</span> options</span>
<span id="cb102-24"><a href="writing-group-policy-extensions.html#cb102-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optparse</span>
<span id="cb102-25"><a href="writing-group-policy-extensions.html#cb102-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-26"><a href="writing-group-policy-extensions.html#cb102-26" aria-hidden="true" tabindex="-1"></a>intro <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb102-27"><a href="writing-group-policy-extensions.html#cb102-27" aria-hidden="true" tabindex="-1"></a><span class="st">### autogenerated by samba</span></span>
<span id="cb102-28"><a href="writing-group-policy-extensions.html#cb102-28" aria-hidden="true" tabindex="-1"></a><span class="st">#</span></span>
<span id="cb102-29"><a href="writing-group-policy-extensions.html#cb102-29" aria-hidden="true" tabindex="-1"></a><span class="st"># This file is generated by the gp_scripts_ext Group Policy</span></span>
<span id="cb102-30"><a href="writing-group-policy-extensions.html#cb102-30" aria-hidden="true" tabindex="-1"></a><span class="st"># Client Side Extension. To modify the contents of this file,</span></span>
<span id="cb102-31"><a href="writing-group-policy-extensions.html#cb102-31" aria-hidden="true" tabindex="-1"></a><span class="st"># modify the appropriate Group Policy objects which apply</span></span>
<span id="cb102-32"><a href="writing-group-policy-extensions.html#cb102-32" aria-hidden="true" tabindex="-1"></a><span class="st"># to this machine. DO NOT MODIFY THIS FILE DIRECTLY.</span></span>
<span id="cb102-33"><a href="writing-group-policy-extensions.html#cb102-33" aria-hidden="true" tabindex="-1"></a><span class="st">#</span></span>
<span id="cb102-34"><a href="writing-group-policy-extensions.html#cb102-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-35"><a href="writing-group-policy-extensions.html#cb102-35" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;&#39;</span></span>
<span id="cb102-36"><a href="writing-group-policy-extensions.html#cb102-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-37"><a href="writing-group-policy-extensions.html#cb102-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> gp_scripts_ext(gp_pol_ext):</span>
<span id="cb102-38"><a href="writing-group-policy-extensions.html#cb102-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb102-39"><a href="writing-group-policy-extensions.html#cb102-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;Unix Settings/Scripts&#39;</span></span>
<span id="cb102-40"><a href="writing-group-policy-extensions.html#cb102-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-41"><a href="writing-group-policy-extensions.html#cb102-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_group_policy(<span class="va">self</span>, deleted_gpo_list, changed_gpo_list):</span>
<span id="cb102-42"><a href="writing-group-policy-extensions.html#cb102-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-43"><a href="writing-group-policy-extensions.html#cb102-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Iterate over GPO guids and their previous settings, reverting</span></span>
<span id="cb102-44"><a href="writing-group-policy-extensions.html#cb102-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># changes made by this GPO.</span></span>
<span id="cb102-45"><a href="writing-group-policy-extensions.html#cb102-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> guid, settings <span class="kw">in</span> deleted_gpo_list:</span>
<span id="cb102-46"><a href="writing-group-policy-extensions.html#cb102-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-47"><a href="writing-group-policy-extensions.html#cb102-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Tell the Group Policy database which GPO we&#39;re working on</span></span>
<span id="cb102-48"><a href="writing-group-policy-extensions.html#cb102-48" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.gp_db.set_guid(guid)</span>
<span id="cb102-49"><a href="writing-group-policy-extensions.html#cb102-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-50"><a href="writing-group-policy-extensions.html#cb102-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">str</span>(<span class="va">self</span>) <span class="kw">in</span> settings:</span>
<span id="cb102-51"><a href="writing-group-policy-extensions.html#cb102-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attribute, script <span class="kw">in</span> settings[<span class="bu">str</span>(<span class="va">self</span>)].items():</span>
<span id="cb102-52"><a href="writing-group-policy-extensions.html#cb102-52" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Delete the applied policy</span></span>
<span id="cb102-53"><a href="writing-group-policy-extensions.html#cb102-53" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> os.path.exists(script):</span>
<span id="cb102-54"><a href="writing-group-policy-extensions.html#cb102-54" aria-hidden="true" tabindex="-1"></a>                        os.unlink(script)</span>
<span id="cb102-55"><a href="writing-group-policy-extensions.html#cb102-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-56"><a href="writing-group-policy-extensions.html#cb102-56" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Remove the stored removal information</span></span>
<span id="cb102-57"><a href="writing-group-policy-extensions.html#cb102-57" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.gp_db.delete(<span class="bu">str</span>(<span class="va">self</span>), attribute)</span>
<span id="cb102-58"><a href="writing-group-policy-extensions.html#cb102-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-59"><a href="writing-group-policy-extensions.html#cb102-59" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Commit the changes to the Group Policy database</span></span>
<span id="cb102-60"><a href="writing-group-policy-extensions.html#cb102-60" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.gp_db.commit()</span>
<span id="cb102-61"><a href="writing-group-policy-extensions.html#cb102-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-62"><a href="writing-group-policy-extensions.html#cb102-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Iterate over GPO objects, applying new policies found in the SYSVOL</span></span>
<span id="cb102-63"><a href="writing-group-policy-extensions.html#cb102-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gpo <span class="kw">in</span> changed_gpo_list:</span>
<span id="cb102-64"><a href="writing-group-policy-extensions.html#cb102-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> gpo.file_sys_path:</span>
<span id="cb102-65"><a href="writing-group-policy-extensions.html#cb102-65" aria-hidden="true" tabindex="-1"></a>                reg_key <span class="op">=</span> <span class="st">&#39;Software</span><span class="ch">\\</span><span class="st">Policies</span><span class="ch">\\</span><span class="st">Samba</span><span class="ch">\\</span><span class="st">Unix Settings&#39;</span></span>
<span id="cb102-66"><a href="writing-group-policy-extensions.html#cb102-66" aria-hidden="true" tabindex="-1"></a>                sections <span class="op">=</span> { <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Daily Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.daily&#39;</span>,</span>
<span id="cb102-67"><a href="writing-group-policy-extensions.html#cb102-67" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Monthly Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.monthly&#39;</span>,</span>
<span id="cb102-68"><a href="writing-group-policy-extensions.html#cb102-68" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Weekly Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.weekly&#39;</span>,</span>
<span id="cb102-69"><a href="writing-group-policy-extensions.html#cb102-69" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Hourly Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.hourly&#39;</span> }</span>
<span id="cb102-70"><a href="writing-group-policy-extensions.html#cb102-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-71"><a href="writing-group-policy-extensions.html#cb102-71" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Tell the Group Policy database which GPO we&#39;re working on</span></span>
<span id="cb102-72"><a href="writing-group-policy-extensions.html#cb102-72" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.gp_db.set_guid(gpo.name)</span>
<span id="cb102-73"><a href="writing-group-policy-extensions.html#cb102-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-74"><a href="writing-group-policy-extensions.html#cb102-74" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Load the contents of the Registry.pol from the SYSVOL</span></span>
<span id="cb102-75"><a href="writing-group-policy-extensions.html#cb102-75" aria-hidden="true" tabindex="-1"></a>                pol_file <span class="op">=</span> <span class="st">&#39;MACHINE/Registry.pol&#39;</span></span>
<span id="cb102-76"><a href="writing-group-policy-extensions.html#cb102-76" aria-hidden="true" tabindex="-1"></a>                path <span class="op">=</span> os.path.join(gpo.file_sys_path, pol_file)</span>
<span id="cb102-77"><a href="writing-group-policy-extensions.html#cb102-77" aria-hidden="true" tabindex="-1"></a>                pol_conf <span class="op">=</span> <span class="va">self</span>.parse(path)</span>
<span id="cb102-78"><a href="writing-group-policy-extensions.html#cb102-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> pol_conf:</span>
<span id="cb102-79"><a href="writing-group-policy-extensions.html#cb102-79" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb102-80"><a href="writing-group-policy-extensions.html#cb102-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-81"><a href="writing-group-policy-extensions.html#cb102-81" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For each policy in the Registry.pol, apply the settings</span></span>
<span id="cb102-82"><a href="writing-group-policy-extensions.html#cb102-82" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> e <span class="kw">in</span> pol_conf.entries:</span>
<span id="cb102-83"><a href="writing-group-policy-extensions.html#cb102-83" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> e.keyname <span class="kw">in</span> sections.keys() <span class="kw">and</span> e.data.strip():</span>
<span id="cb102-84"><a href="writing-group-policy-extensions.html#cb102-84" aria-hidden="true" tabindex="-1"></a>                        cron_dir <span class="op">=</span> sections[e.keyname]</span>
<span id="cb102-85"><a href="writing-group-policy-extensions.html#cb102-85" aria-hidden="true" tabindex="-1"></a>                        attribute <span class="op">=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="st">:</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (e.keyname,</span>
<span id="cb102-86"><a href="writing-group-policy-extensions.html#cb102-86" aria-hidden="true" tabindex="-1"></a>                                b64encode(e.data.encode()).decode())</span>
<span id="cb102-87"><a href="writing-group-policy-extensions.html#cb102-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-88"><a href="writing-group-policy-extensions.html#cb102-88" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Check if this policy has already been applied in the</span></span>
<span id="cb102-89"><a href="writing-group-policy-extensions.html#cb102-89" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Group Policy database. Skip the apply if it&#39;s already</span></span>
<span id="cb102-90"><a href="writing-group-policy-extensions.html#cb102-90" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># been installed.</span></span>
<span id="cb102-91"><a href="writing-group-policy-extensions.html#cb102-91" aria-hidden="true" tabindex="-1"></a>                        old_val <span class="op">=</span> <span class="va">self</span>.gp_db.retrieve(<span class="bu">str</span>(<span class="va">self</span>), attribute)</span>
<span id="cb102-92"><a href="writing-group-policy-extensions.html#cb102-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-93"><a href="writing-group-policy-extensions.html#cb102-93" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">not</span> old_val:</span>
<span id="cb102-94"><a href="writing-group-policy-extensions.html#cb102-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-95"><a href="writing-group-policy-extensions.html#cb102-95" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># Create a temporary file and store policy in it,</span></span>
<span id="cb102-96"><a href="writing-group-policy-extensions.html#cb102-96" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># then move the file to the cron directory for</span></span>
<span id="cb102-97"><a href="writing-group-policy-extensions.html#cb102-97" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># execution.</span></span>
<span id="cb102-98"><a href="writing-group-policy-extensions.html#cb102-98" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">with</span> NamedTemporaryFile(prefix<span class="op">=</span><span class="st">&#39;gp_&#39;</span>, mode<span class="op">=</span><span class="st">&quot;w+&quot;</span>,</span>
<span id="cb102-99"><a href="writing-group-policy-extensions.html#cb102-99" aria-hidden="true" tabindex="-1"></a>                                    delete<span class="op">=</span><span class="va">False</span>, <span class="bu">dir</span><span class="op">=</span>cron_dir) <span class="im">as</span> f:</span>
<span id="cb102-100"><a href="writing-group-policy-extensions.html#cb102-100" aria-hidden="true" tabindex="-1"></a>                                contents <span class="op">=</span> <span class="st">&#39;#!/bin/sh</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> intro</span>
<span id="cb102-101"><a href="writing-group-policy-extensions.html#cb102-101" aria-hidden="true" tabindex="-1"></a>                                contents <span class="op">+=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\n</span><span class="st">&#39;</span> <span class="op">%</span> e.data</span>
<span id="cb102-102"><a href="writing-group-policy-extensions.html#cb102-102" aria-hidden="true" tabindex="-1"></a>                                f.write(contents)</span>
<span id="cb102-103"><a href="writing-group-policy-extensions.html#cb102-103" aria-hidden="true" tabindex="-1"></a>                                os.chmod(f.name, <span class="bn">0o700</span>)</span>
<span id="cb102-104"><a href="writing-group-policy-extensions.html#cb102-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-105"><a href="writing-group-policy-extensions.html#cb102-105" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># Store the name of the applied file, so that</span></span>
<span id="cb102-106"><a href="writing-group-policy-extensions.html#cb102-106" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># we can remove it later on unapply (see the</span></span>
<span id="cb102-107"><a href="writing-group-policy-extensions.html#cb102-107" aria-hidden="true" tabindex="-1"></a>                                <span class="co"># first loop in this function).</span></span>
<span id="cb102-108"><a href="writing-group-policy-extensions.html#cb102-108" aria-hidden="true" tabindex="-1"></a>                                <span class="va">self</span>.gp_db.store(<span class="bu">str</span>(<span class="va">self</span>), attribute, f.name)</span>
<span id="cb102-109"><a href="writing-group-policy-extensions.html#cb102-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-110"><a href="writing-group-policy-extensions.html#cb102-110" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Commit the changes to the Group Policy database</span></span>
<span id="cb102-111"><a href="writing-group-policy-extensions.html#cb102-111" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.gp_db.commit()</span>
<span id="cb102-112"><a href="writing-group-policy-extensions.html#cb102-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-113"><a href="writing-group-policy-extensions.html#cb102-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> rsop(<span class="va">self</span>, gpo):</span>
<span id="cb102-114"><a href="writing-group-policy-extensions.html#cb102-114" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> {}</span>
<span id="cb102-115"><a href="writing-group-policy-extensions.html#cb102-115" aria-hidden="true" tabindex="-1"></a>        pol_file <span class="op">=</span> <span class="st">&#39;MACHINE/Registry.pol&#39;</span></span>
<span id="cb102-116"><a href="writing-group-policy-extensions.html#cb102-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gpo.file_sys_path:</span>
<span id="cb102-117"><a href="writing-group-policy-extensions.html#cb102-117" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> os.path.join(gpo.file_sys_path, pol_file)</span>
<span id="cb102-118"><a href="writing-group-policy-extensions.html#cb102-118" aria-hidden="true" tabindex="-1"></a>            pol_conf <span class="op">=</span> <span class="va">self</span>.parse(path)</span>
<span id="cb102-119"><a href="writing-group-policy-extensions.html#cb102-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> pol_conf:</span>
<span id="cb102-120"><a href="writing-group-policy-extensions.html#cb102-120" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> output</span>
<span id="cb102-121"><a href="writing-group-policy-extensions.html#cb102-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> e <span class="kw">in</span> pol_conf.entries:</span>
<span id="cb102-122"><a href="writing-group-policy-extensions.html#cb102-122" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> e.keyname.split(<span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb102-123"><a href="writing-group-policy-extensions.html#cb102-123" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key.endswith(<span class="st">&#39;Scripts&#39;</span>) <span class="kw">and</span> e.data.strip():</span>
<span id="cb102-124"><a href="writing-group-policy-extensions.html#cb102-124" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> output.keys():</span>
<span id="cb102-125"><a href="writing-group-policy-extensions.html#cb102-125" aria-hidden="true" tabindex="-1"></a>                        output[key] <span class="op">=</span> []</span>
<span id="cb102-126"><a href="writing-group-policy-extensions.html#cb102-126" aria-hidden="true" tabindex="-1"></a>                    output[key].append(e.data)</span>
<span id="cb102-127"><a href="writing-group-policy-extensions.html#cb102-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb102-128"><a href="writing-group-policy-extensions.html#cb102-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-129"><a href="writing-group-policy-extensions.html#cb102-129" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb102-130"><a href="writing-group-policy-extensions.html#cb102-130" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> optparse.OptionParser(<span class="st">&#39;gp_scripts_ext.py [options]&#39;</span>)</span>
<span id="cb102-131"><a href="writing-group-policy-extensions.html#cb102-131" aria-hidden="true" tabindex="-1"></a>    sambaopts <span class="op">=</span> options.SambaOptions(parser)</span>
<span id="cb102-132"><a href="writing-group-policy-extensions.html#cb102-132" aria-hidden="true" tabindex="-1"></a>    parser.add_option_group(sambaopts)</span>
<span id="cb102-133"><a href="writing-group-policy-extensions.html#cb102-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-134"><a href="writing-group-policy-extensions.html#cb102-134" aria-hidden="true" tabindex="-1"></a>    parser.add_option(<span class="st">&#39;--register&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Register extension to Samba&#39;</span>,</span>
<span id="cb102-135"><a href="writing-group-policy-extensions.html#cb102-135" aria-hidden="true" tabindex="-1"></a>                      action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>)</span>
<span id="cb102-136"><a href="writing-group-policy-extensions.html#cb102-136" aria-hidden="true" tabindex="-1"></a>    parser.add_option(<span class="st">&#39;--unregister&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Unregister extension from Samba&#39;</span>,</span>
<span id="cb102-137"><a href="writing-group-policy-extensions.html#cb102-137" aria-hidden="true" tabindex="-1"></a>                      action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>)</span>
<span id="cb102-138"><a href="writing-group-policy-extensions.html#cb102-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-139"><a href="writing-group-policy-extensions.html#cb102-139" aria-hidden="true" tabindex="-1"></a>    (opts, args) <span class="op">=</span> parser.parse_args()</span>
<span id="cb102-140"><a href="writing-group-policy-extensions.html#cb102-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-141"><a href="writing-group-policy-extensions.html#cb102-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We&#39;re collecting the Samba loadparm simply to find our smb.conf file</span></span>
<span id="cb102-142"><a href="writing-group-policy-extensions.html#cb102-142" aria-hidden="true" tabindex="-1"></a>    lp <span class="op">=</span> sambaopts.get_loadparm()</span>
<span id="cb102-143"><a href="writing-group-policy-extensions.html#cb102-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-144"><a href="writing-group-policy-extensions.html#cb102-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is a random unique GUID, which identifies this CSE.</span></span>
<span id="cb102-145"><a href="writing-group-policy-extensions.html#cb102-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Any random GUID will do.</span></span>
<span id="cb102-146"><a href="writing-group-policy-extensions.html#cb102-146" aria-hidden="true" tabindex="-1"></a>    ext_guid <span class="op">=</span> <span class="st">&#39;{5930022C-94FF-4ED5-A403-CFB4549DB6F0}&#39;</span></span>
<span id="cb102-147"><a href="writing-group-policy-extensions.html#cb102-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> opts.register:</span>
<span id="cb102-148"><a href="writing-group-policy-extensions.html#cb102-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The extension path is the location of this file. This script</span></span>
<span id="cb102-149"><a href="writing-group-policy-extensions.html#cb102-149" aria-hidden="true" tabindex="-1"></a>        <span class="co"># should be executed from a permanent location.</span></span>
<span id="cb102-150"><a href="writing-group-policy-extensions.html#cb102-150" aria-hidden="true" tabindex="-1"></a>        ext_path <span class="op">=</span> os.path.realpath(<span class="va">__file__</span>)</span>
<span id="cb102-151"><a href="writing-group-policy-extensions.html#cb102-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The machine and user parameters tell Samba whether to apply this</span></span>
<span id="cb102-152"><a href="writing-group-policy-extensions.html#cb102-152" aria-hidden="true" tabindex="-1"></a>        <span class="co"># extension to the computer, to individual users, or to both.</span></span>
<span id="cb102-153"><a href="writing-group-policy-extensions.html#cb102-153" aria-hidden="true" tabindex="-1"></a>        register_gp_extension(ext_guid, <span class="st">&#39;gp_scripts_ext&#39;</span>, ext_path,</span>
<span id="cb102-154"><a href="writing-group-policy-extensions.html#cb102-154" aria-hidden="true" tabindex="-1"></a>                              smb_conf<span class="op">=</span>lp.configfile, machine<span class="op">=</span><span class="va">True</span>, user<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb102-155"><a href="writing-group-policy-extensions.html#cb102-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> opts.unregister:</span>
<span id="cb102-156"><a href="writing-group-policy-extensions.html#cb102-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove the extension and do not apply policy.</span></span>
<span id="cb102-157"><a href="writing-group-policy-extensions.html#cb102-157" aria-hidden="true" tabindex="-1"></a>        unregister_gp_extension(ext_guid)</span>
<span id="cb102-158"><a href="writing-group-policy-extensions.html#cb102-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-159"><a href="writing-group-policy-extensions.html#cb102-159" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List the currently installed Group Policy Client Side Extensions</span></span>
<span id="cb102-160"><a href="writing-group-policy-extensions.html#cb102-160" aria-hidden="true" tabindex="-1"></a>    exts <span class="op">=</span> list_gp_extensions(lp.configfile)</span>
<span id="cb102-161"><a href="writing-group-policy-extensions.html#cb102-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> guid, data <span class="kw">in</span> exts.items():</span>
<span id="cb102-162"><a href="writing-group-policy-extensions.html#cb102-162" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(guid)</span>
<span id="cb102-163"><a href="writing-group-policy-extensions.html#cb102-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k, v <span class="kw">in</span> data.items():</span>
<span id="cb102-164"><a href="writing-group-policy-extensions.html#cb102-164" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&#39;</span><span class="ch">\t</span><span class="sc">%s</span><span class="st">: </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (k, v))</span></code></pre></div>
<div id="the-gp_pol_extgp_inf_ext-python-classes" class="section level3 hasAnchor" number="19.2.1">
<h3><span class="header-section-number">19.2.1</span> The gp_pol_ext/gp_inf_ext Python Classes<a href="writing-group-policy-extensions.html#the-gp_pol_extgp_inf_ext-python-classes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Your CSE must be a class that inherits from a subclass of <code>gp_ext</code>. The <code>gp_pol_ext</code> is a subclass of <code>gp_ext</code> that provides simplified parsing of Registry.pol files. If you choose to store your policies in ini/inf files in the SYSVOL (instead of using Administrative Templates), then you can inherit from the <code>gp_inf_ext</code> instead.</p>
<p>If your class inherits from either <code>gp_pol_ext</code> or <code>gp_inf_ext</code>, it has a <code>parse()</code> function defined, which takes a single filename. The parse() function will parse the contents of the policy file and return it in a sensible format.</p>
<p>If for some reason you choose to store data on the SYSVOL in some other format (such as in XML, etc), you’ll need to subclass <code>gp_ext</code>, then implement a <code>read()</code> function, like this:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="writing-group-policy-extensions.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xml.etree.ElementTree</span>
<span id="cb103-2"><a href="writing-group-policy-extensions.html#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> gp_xml_ext(gp_ext):</span>
<span id="cb103-3"><a href="writing-group-policy-extensions.html#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read(<span class="va">self</span>, data_file):</span>
<span id="cb103-4"><a href="writing-group-policy-extensions.html#cb103-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> xml.etree.ElementTree.parse(data_file)</span></code></pre></div>
<p>The <code>read()</code> function is called by <code>parse()</code>, passing it a local filename tied to the systems SYSVOL cache. Then within <code>process_group_policy()</code> you can call <code>parse()</code> to fetch the parsed data from the SYSVOL.</p>
</div>
<div id="process-group-policy" class="section level3 hasAnchor" number="19.2.2">
<h3><span class="header-section-number">19.2.2</span> Process Group Policy<a href="writing-group-policy-extensions.html#process-group-policy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>process_group_policy()</code> function serves two primary purposes; it applies new policy, and it removes old policy. In the example, you’ll notice there are two main loops. The first loop iterates over the <code>deleted_gpo_list</code>, which are all the policies that should be removed. The second loop iterates over the <code>changed_gpo_list</code>, which are new policies which must be applied.</p>
</div>
<div id="deleted-gpos" class="section level3 hasAnchor" number="19.2.3">
<h3><span class="header-section-number">19.2.3</span> Deleted GPOs<a href="writing-group-policy-extensions.html#deleted-gpos" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="writing-group-policy-extensions.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> guid, settings <span class="kw">in</span> deleted_gpo_list:</span>
<span id="cb104-2"><a href="writing-group-policy-extensions.html#cb104-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.gp_db.set_guid(guid)</span>
<span id="cb104-3"><a href="writing-group-policy-extensions.html#cb104-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">str</span>(<span class="va">self</span>) <span class="kw">in</span> settings:</span>
<span id="cb104-4"><a href="writing-group-policy-extensions.html#cb104-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attribute, script <span class="kw">in</span> settings[<span class="bu">str</span>(<span class="va">self</span>)].items():</span>
<span id="cb104-5"><a href="writing-group-policy-extensions.html#cb104-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> os.path.exists(script):</span>
<span id="cb104-6"><a href="writing-group-policy-extensions.html#cb104-6" aria-hidden="true" tabindex="-1"></a>                os.unlink(script)</span>
<span id="cb104-7"><a href="writing-group-policy-extensions.html#cb104-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.gp_db.delete(<span class="bu">str</span>(<span class="va">self</span>), attribute)</span>
<span id="cb104-8"><a href="writing-group-policy-extensions.html#cb104-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.gp_db.commit()</span></code></pre></div>
<p>The <code>deleted_gpo_list</code> is a dictionary which contains the guids of Group Policy Objects, with associated settings which were previously applied. This list of applied settings is generated by the second loop (<code>changed_gpo_list</code>) while it is applying policy. The <code>self.gp_db</code> object is a database handle which allows you to manipulate the Group Policy Database.</p>
<p>The Group Policy Database keeps track of all settings that have been applied, and info on how to revert those applied settings. For example, in the smb.conf CSE, the attribute stored in <code>settings</code> could be <code>client max protocol</code> and the stored value could be <code>NT1</code>. If our GPO has applied a <code>client max protocol</code> set to SMB3_11, the Group Policy database keeps track of the previous value of <code>NT1</code> for when it’s time to remove the SMB3_11 policy.</p>
<p>In our example cron script policy above, you can see that the stored value is a filename (the script variable). This is actually the name of the script we’ve applied, which will allow us to delete it later (therefore removing the policy). The scripts CSE is a special case, where we don’t need to keep track of an old value to restore, instead we’re keeping track of files to delete (since the ‘old value’ is that the script didn’t exist).</p>
</div>
<div id="changed-gpos" class="section level3 hasAnchor" number="19.2.4">
<h3><span class="header-section-number">19.2.4</span> Changed GPOs<a href="writing-group-policy-extensions.html#changed-gpos" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb105"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="writing-group-policy-extensions.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> gpo <span class="kw">in</span> changed_gpo_list:</span>
<span id="cb105-2"><a href="writing-group-policy-extensions.html#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gpo.file_sys_path:</span>
<span id="cb105-3"><a href="writing-group-policy-extensions.html#cb105-3" aria-hidden="true" tabindex="-1"></a>        reg_key <span class="op">=</span> <span class="st">&#39;Software</span><span class="ch">\\</span><span class="st">Policies</span><span class="ch">\\</span><span class="st">Samba</span><span class="ch">\\</span><span class="st">Unix Settings&#39;</span></span>
<span id="cb105-4"><a href="writing-group-policy-extensions.html#cb105-4" aria-hidden="true" tabindex="-1"></a>        sections <span class="op">=</span> { <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Daily Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.daily&#39;</span>,</span>
<span id="cb105-5"><a href="writing-group-policy-extensions.html#cb105-5" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Monthly Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.monthly&#39;</span>,</span>
<span id="cb105-6"><a href="writing-group-policy-extensions.html#cb105-6" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Weekly Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.weekly&#39;</span>,</span>
<span id="cb105-7"><a href="writing-group-policy-extensions.html#cb105-7" aria-hidden="true" tabindex="-1"></a>                     <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Hourly Scripts&#39;</span> <span class="op">%</span> reg_key : <span class="st">&#39;/etc/cron.hourly&#39;</span> }</span>
<span id="cb105-8"><a href="writing-group-policy-extensions.html#cb105-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gp_db.set_guid(gpo.name)</span>
<span id="cb105-9"><a href="writing-group-policy-extensions.html#cb105-9" aria-hidden="true" tabindex="-1"></a>        pol_file <span class="op">=</span> <span class="st">&#39;MACHINE/Registry.pol&#39;</span></span>
<span id="cb105-10"><a href="writing-group-policy-extensions.html#cb105-10" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> os.path.join(gpo.file_sys_path, pol_file)</span>
<span id="cb105-11"><a href="writing-group-policy-extensions.html#cb105-11" aria-hidden="true" tabindex="-1"></a>        pol_conf <span class="op">=</span> <span class="va">self</span>.parse(path)</span>
<span id="cb105-12"><a href="writing-group-policy-extensions.html#cb105-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> pol_conf:</span>
<span id="cb105-13"><a href="writing-group-policy-extensions.html#cb105-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb105-14"><a href="writing-group-policy-extensions.html#cb105-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> e <span class="kw">in</span> pol_conf.entries:</span>
<span id="cb105-15"><a href="writing-group-policy-extensions.html#cb105-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> e.keyname <span class="kw">in</span> sections.keys() <span class="kw">and</span> e.data.strip():</span>
<span id="cb105-16"><a href="writing-group-policy-extensions.html#cb105-16" aria-hidden="true" tabindex="-1"></a>                cron_dir <span class="op">=</span> sections[e.keyname]</span>
<span id="cb105-17"><a href="writing-group-policy-extensions.html#cb105-17" aria-hidden="true" tabindex="-1"></a>                attribute <span class="op">=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="st">:</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (e.keyname,</span>
<span id="cb105-18"><a href="writing-group-policy-extensions.html#cb105-18" aria-hidden="true" tabindex="-1"></a>                        b64encode(e.data.encode()).decode())</span>
<span id="cb105-19"><a href="writing-group-policy-extensions.html#cb105-19" aria-hidden="true" tabindex="-1"></a>                old_val <span class="op">=</span> <span class="va">self</span>.gp_db.retrieve(<span class="bu">str</span>(<span class="va">self</span>), attribute)</span>
<span id="cb105-20"><a href="writing-group-policy-extensions.html#cb105-20" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> old_val:</span>
<span id="cb105-21"><a href="writing-group-policy-extensions.html#cb105-21" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">with</span> NamedTemporaryFile(prefix<span class="op">=</span><span class="st">&#39;gp_&#39;</span>, mode<span class="op">=</span><span class="st">&quot;w+&quot;</span>,</span>
<span id="cb105-22"><a href="writing-group-policy-extensions.html#cb105-22" aria-hidden="true" tabindex="-1"></a>                            delete<span class="op">=</span><span class="va">False</span>, <span class="bu">dir</span><span class="op">=</span>cron_dir) <span class="im">as</span> f:</span>
<span id="cb105-23"><a href="writing-group-policy-extensions.html#cb105-23" aria-hidden="true" tabindex="-1"></a>                        contents <span class="op">=</span> <span class="st">&#39;#!/bin/sh</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> intro </span>
<span id="cb105-24"><a href="writing-group-policy-extensions.html#cb105-24" aria-hidden="true" tabindex="-1"></a>                        contents <span class="op">+=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\n</span><span class="st">&#39;</span> <span class="op">%</span> e.data</span>
<span id="cb105-25"><a href="writing-group-policy-extensions.html#cb105-25" aria-hidden="true" tabindex="-1"></a>                        f.write(contents)</span>
<span id="cb105-26"><a href="writing-group-policy-extensions.html#cb105-26" aria-hidden="true" tabindex="-1"></a>                        os.chmod(f.name, <span class="bn">0o700</span>)</span>
<span id="cb105-27"><a href="writing-group-policy-extensions.html#cb105-27" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.gp_db.store(<span class="bu">str</span>(<span class="va">self</span>), attribute, f.name) </span>
<span id="cb105-28"><a href="writing-group-policy-extensions.html#cb105-28" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.gp_db.commit()</span></code></pre></div>
<p>The second loop is a little more involved. When we iterate over <code>changed_gpo_list</code>, we’re actually iterating over a list of GPO objects. The attributes of the object are:</p>
<ul>
<li><code>gpo.name</code>: The GUID of the GPO.</li>
<li><code>gpo.file_sys_path</code>: A physical path to a cache of GPO on the local filesystem.</li>
</ul>
<p>There are other methods and attributes, but these are the only ones important to a CSE.</p>
<p>The primary purpose of this loop is to iterate over the GPOs, read their policy in the SYSVOL, then check the sections for the Registry Key we created in our Server Side Extension. If our policy Registry Key exists, then we read the entry and apply the policy.</p>
<p>In our example, we find the ‘Software\Policies\Samba\Unix Settings\Daily Scripts’ policy, then read the script contents from Registry.pol entry and write the script to a local file. In the example code, we write the script to a temporary file, then move the file to it’s permanent location in /etc/cron.daily.</p>
<p>We also have to make sure we set the name of the new script in our <code>self.gp_db</code> (Group Policy Database). This ensures that we can remove the policy when we delete the GPO. At the beginning of our loop, we also need to ensure we call <code>set_guid()</code> on our Group Policy Database, so it knows which GPO we’re operating on.</p>
</div>
<div id="resultant-set-of-policy" class="section level3 hasAnchor" number="19.2.5">
<h3><span class="header-section-number">19.2.5</span> Resultant Set of Policy<a href="writing-group-policy-extensions.html#resultant-set-of-policy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The rsop() function in the extension is optional. It should return a dictionary containing key/value pairs of what our current policy will or has applied. The function is passed a list of GPO objects (similar to our <code>changed_gpo_list</code>), and we should parse the list similar to how we did in our <code>changed_gpo_list</code> loop. The difference is that the rsop() function does not apply any policy. It only returns what will be applied. This function enables the <code>samba-gpupdate --rsop</code> command to report on applied, or soon to be applied policy.</p>
</div>
<div id="registeringunregistering-a-client-side-extension" class="section level3 hasAnchor" number="19.2.6">
<h3><span class="header-section-number">19.2.6</span> Registering/Unregistering a Client Side Extension<a href="writing-group-policy-extensions.html#registeringunregistering-a-client-side-extension" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The final step is to register an extension on the host. While the example code provides a detailed example of how to register an extension, the basic requirement is simply to call <code>register_gp_extension()</code>.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="writing-group-policy-extensions.html#cb106-1" aria-hidden="true" tabindex="-1"></a>ext_guid <span class="op">=</span> <span class="st">&#39;{5930022C-94FF-4ED5-A403-CFB4549DB6F0}&#39;</span></span>
<span id="cb106-2"><a href="writing-group-policy-extensions.html#cb106-2" aria-hidden="true" tabindex="-1"></a>ext_path <span class="op">=</span> os.path.realpath(<span class="va">__file__</span>)</span>
<span id="cb106-3"><a href="writing-group-policy-extensions.html#cb106-3" aria-hidden="true" tabindex="-1"></a>register_gp_extension(ext_guid, <span class="st">&#39;gp_scripts_ext&#39;</span>, ext_path,</span>
<span id="cb106-4"><a href="writing-group-policy-extensions.html#cb106-4" aria-hidden="true" tabindex="-1"></a>    smb_conf<span class="op">=</span><span class="st">&#39;/etc/samba/smb.conf&#39;</span>, machine<span class="op">=</span><span class="va">True</span>, user<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>The extension guid can be any random guid. It simply must be unique among all extensions that you register to the host. The extension path is literally just the path to the source file containing your CSE.</p>
<p>You must pass your smb.conf file to the extension, so it knows where to store the list of registered extensions. You also must specify whether to apply this extension to the machine, or to individual users (or to both).</p>
<p>Unregistering the extension is simple. You call the <code>unregister_gp_extension()</code> and pass it the unique guid you previously chose which represents this CSE.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="firewalld.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="regpol.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
