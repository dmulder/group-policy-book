<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>19 Writing Group Policy Extensions | Group Policy on Linux</title>
  <meta name="description" content="<p>This book introduces the user to opensource tools for managing Linux
clients via Group Policy.</p>" />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="19 Writing Group Policy Extensions | Group Policy on Linux" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://dmulder.github.io/group-policy-book/cover-image.png" />
  <meta property="og:description" content="<p>This book introduces the user to opensource tools for managing Linux
clients via Group Policy.</p>" />
  <meta name="github-repo" content="dmulder/group-policy-book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="19 Writing Group Policy Extensions | Group Policy on Linux" />
  
  <meta name="twitter:description" content="<p>This book introduces the user to opensource tools for managing Linux
clients via Group Policy.</p>" />
  <meta name="twitter:image" content="https://dmulder.github.io/group-policy-book/cover-image.png" />

<meta name="author" content="David Mulder" />


<meta name="date" content="2022-12-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="firewalld.html"/>
<link rel="next" href="regpol.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#about-the-author"><i class="fa fa-check"></i><b>1.1</b> About the Author</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#whats-the-difference-between-group-policy-and-a-group-policy-object"><i class="fa fa-check"></i><b>2.1</b> What’s the difference between Group Policy and a Group Policy Object?</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#server-side-extensions"><i class="fa fa-check"></i><b>2.2</b> Server Side Extensions</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="intro.html"><a href="intro.html#enabling-group-policy-server-side-extensions-on-the-server"><i class="fa fa-check"></i><b>2.2.1</b> Enabling Group Policy Server Side Extensions on the Server</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#client-side-extensions"><i class="fa fa-check"></i><b>2.3</b> Client Side Extensions</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="intro.html"><a href="intro.html#enabling-group-policy-client-side-extensions-on-the-linux-client"><i class="fa fa-check"></i><b>2.3.1</b> Enabling Group Policy Client Side Extensions on the Linux Client</a></li>
<li class="chapter" data-level="2.3.2" data-path="intro.html"><a href="intro.html#rsop"><i class="fa fa-check"></i><b>2.3.2</b> Resultant Set of Policy</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#policies-introduced-in-this-book"><i class="fa fa-check"></i><b>2.4</b> Policies Introduced in this Book</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="intro.html"><a href="intro.html#smb.conf-policies"><i class="fa fa-check"></i><b>2.4.1</b> smb.conf Policies</a></li>
<li class="chapter" data-level="2.4.2" data-path="intro.html"><a href="intro.html#password-and-kerberos-policies"><i class="fa fa-check"></i><b>2.4.2</b> Password and Kerberos Policies</a></li>
<li class="chapter" data-level="2.4.3" data-path="intro.html"><a href="intro.html#script-policies"><i class="fa fa-check"></i><b>2.4.3</b> Script Policies</a></li>
<li class="chapter" data-level="2.4.4" data-path="intro.html"><a href="intro.html#startup-script-policies"><i class="fa fa-check"></i><b>2.4.4</b> Startup Script Policies</a></li>
<li class="chapter" data-level="2.4.5" data-path="intro.html"><a href="intro.html#files-policy"><i class="fa fa-check"></i><b>2.4.5</b> Files Policy</a></li>
<li class="chapter" data-level="2.4.6" data-path="intro.html"><a href="intro.html#symlink-policies"><i class="fa fa-check"></i><b>2.4.6</b> Symlink Policies</a></li>
<li class="chapter" data-level="2.4.7" data-path="intro.html"><a href="intro.html#sudoers-policies"><i class="fa fa-check"></i><b>2.4.7</b> Sudoers Policies</a></li>
<li class="chapter" data-level="2.4.8" data-path="intro.html"><a href="intro.html#message-policies"><i class="fa fa-check"></i><b>2.4.8</b> Message Policies</a></li>
<li class="chapter" data-level="2.4.9" data-path="intro.html"><a href="intro.html#pam-access-policies"><i class="fa fa-check"></i><b>2.4.9</b> PAM Access Policies</a></li>
<li class="chapter" data-level="2.4.10" data-path="intro.html"><a href="intro.html#certificate-auto-enrollment"><i class="fa fa-check"></i><b>2.4.10</b> Certificate Auto Enrollment</a></li>
<li class="chapter" data-level="2.4.11" data-path="intro.html"><a href="intro.html#firefox-policy"><i class="fa fa-check"></i><b>2.4.11</b> Firefox Policy</a></li>
<li class="chapter" data-level="2.4.12" data-path="intro.html"><a href="intro.html#chromiumchrome-policy"><i class="fa fa-check"></i><b>2.4.12</b> Chromium/Chrome Policy</a></li>
<li class="chapter" data-level="2.4.13" data-path="intro.html"><a href="intro.html#gnome-settings"><i class="fa fa-check"></i><b>2.4.13</b> GNOME Settings</a></li>
<li class="chapter" data-level="2.4.14" data-path="intro.html"><a href="intro.html#openssh-policy"><i class="fa fa-check"></i><b>2.4.14</b> OpenSSH Policy</a></li>
<li class="chapter" data-level="2.4.15" data-path="intro.html"><a href="intro.html#firewalld-policy"><i class="fa fa-check"></i><b>2.4.15</b> Firewalld Policy</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="manage.html"><a href="manage.html"><i class="fa fa-check"></i><b>3</b> Managing Group Policies</a>
<ul>
<li class="chapter" data-level="3.1" data-path="manage.html"><a href="manage.html#gpopen"><i class="fa fa-check"></i><b>3.1</b> Opening a Group Policy Object in the Group Policy Management Console</a></li>
<li class="chapter" data-level="3.2" data-path="manage.html"><a href="manage.html#gpcreate"><i class="fa fa-check"></i><b>3.2</b> Creating a Group Policy Object</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="manage.html"><a href="manage.html#samba-tool"><i class="fa fa-check"></i><b>3.2.1</b> samba-tool</a></li>
<li class="chapter" data-level="3.2.2" data-path="manage.html"><a href="manage.html#gpmc"><i class="fa fa-check"></i><b>3.2.2</b> GPMC</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="manage.html"><a href="manage.html#gpdelete"><i class="fa fa-check"></i><b>3.3</b> Deleting a Group Policy Object</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="manage.html"><a href="manage.html#samba-tool-1"><i class="fa fa-check"></i><b>3.3.1</b> samba-tool</a></li>
<li class="chapter" data-level="3.3.2" data-path="manage.html"><a href="manage.html#gpmc-1"><i class="fa fa-check"></i><b>3.3.2</b> GPMC</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="manage.html"><a href="manage.html#gplist"><i class="fa fa-check"></i><b>3.4</b> Listing a Group Policy</a></li>
<li class="chapter" data-level="3.5" data-path="manage.html"><a href="manage.html#gpmodify"><i class="fa fa-check"></i><b>3.5</b> Modifying a Group Policy</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="smbconf.html"><a href="smbconf.html"><i class="fa fa-check"></i><b>4</b> smb.conf Policies</a>
<ul>
<li class="chapter" data-level="4.1" data-path="smbconf.html"><a href="smbconf.html#smbconf-sse"><i class="fa fa-check"></i><b>4.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="smbconf.html"><a href="smbconf.html#managing-smb.conf-policies-via-the-gpme"><i class="fa fa-check"></i><b>4.1.1</b> Managing smb.conf Policies via the GPME</a></li>
<li class="chapter" data-level="4.1.2" data-path="smbconf.html"><a href="smbconf.html#managing-smb.conf-policies-via-samba-tool"><i class="fa fa-check"></i><b>4.1.2</b> Managing smb.conf Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="smbconf.html"><a href="smbconf.html#client-side-extension"><i class="fa fa-check"></i><b>4.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="sec.html"><a href="sec.html"><i class="fa fa-check"></i><b>5</b> Password and Kerberos Policies</a>
<ul>
<li class="chapter" data-level="5.1" data-path="sec.html"><a href="sec.html#server-side-extension"><i class="fa fa-check"></i><b>5.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="sec.html"><a href="sec.html#managing-password-and-kerberos-policies-via-the-gpme"><i class="fa fa-check"></i><b>5.1.1</b> Managing Password and Kerberos Policies via the GPME</a></li>
<li class="chapter" data-level="5.1.2" data-path="sec.html"><a href="sec.html#managing-password-and-kerberos-policies-via-samba-tool"><i class="fa fa-check"></i><b>5.1.2</b> Managing Password and Kerberos Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="sec.html"><a href="sec.html#client-side-extension-1"><i class="fa fa-check"></i><b>5.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="scripts.html"><a href="scripts.html"><i class="fa fa-check"></i><b>6</b> Script Policies</a>
<ul>
<li class="chapter" data-level="6.1" data-path="scripts.html"><a href="scripts.html#server-side-extension-1"><i class="fa fa-check"></i><b>6.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="scripts.html"><a href="scripts.html#scripts-gpme"><i class="fa fa-check"></i><b>6.1.1</b> Managing Machine Scripts Policies via the GPME</a></li>
<li class="chapter" data-level="6.1.2" data-path="scripts.html"><a href="scripts.html#managing-user-scripts-policies-via-the-gpme"><i class="fa fa-check"></i><b>6.1.2</b> Managing User Scripts Policies via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="scripts.html"><a href="scripts.html#client-side-extension-2"><i class="fa fa-check"></i><b>6.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="startupscripts.html"><a href="startupscripts.html"><i class="fa fa-check"></i><b>7</b> Startup Script Policies</a>
<ul>
<li class="chapter" data-level="7.1" data-path="startupscripts.html"><a href="startupscripts.html#server-side-extension-2"><i class="fa fa-check"></i><b>7.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="startupscripts.html"><a href="startupscripts.html#managing-startup-script-policies-via-samba-tool"><i class="fa fa-check"></i><b>7.1.1</b> Managing Startup Script Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="startupscripts.html"><a href="startupscripts.html#client-side-extension-3"><i class="fa fa-check"></i><b>7.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="files.html"><a href="files.html"><i class="fa fa-check"></i><b>8</b> Files Policy</a>
<ul>
<li class="chapter" data-level="8.1" data-path="files.html"><a href="files.html#server-side-extension-3"><i class="fa fa-check"></i><b>8.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="files.html"><a href="files.html#managing-the-files-policy-via-samba-tool"><i class="fa fa-check"></i><b>8.1.1</b> Managing the Files Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="files.html"><a href="files.html#client-side-extension-4"><i class="fa fa-check"></i><b>8.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="symlink.html"><a href="symlink.html"><i class="fa fa-check"></i><b>9</b> Symlink Policies</a>
<ul>
<li class="chapter" data-level="9.1" data-path="symlink.html"><a href="symlink.html#server-side-extension-4"><i class="fa fa-check"></i><b>9.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="symlink.html"><a href="symlink.html#managing-the-symlink-policy-via-samba-tool"><i class="fa fa-check"></i><b>9.1.1</b> Managing the Symlink Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="symlink.html"><a href="symlink.html#client-side-extension-5"><i class="fa fa-check"></i><b>9.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="sudoers.html"><a href="sudoers.html"><i class="fa fa-check"></i><b>10</b> Sudoers Policies</a>
<ul>
<li class="chapter" data-level="10.1" data-path="sudoers.html"><a href="sudoers.html#server-side-extension-5"><i class="fa fa-check"></i><b>10.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="sudoers.html"><a href="sudoers.html#sudoers-gpme"><i class="fa fa-check"></i><b>10.1.1</b> Managing Sudoers Policy via the GPME</a></li>
<li class="chapter" data-level="10.1.2" data-path="sudoers.html"><a href="sudoers.html#sudoers-samba-tool"><i class="fa fa-check"></i><b>10.1.2</b> Managing Sudoers Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="sudoers.html"><a href="sudoers.html#client-side-extension-6"><i class="fa fa-check"></i><b>10.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="msgs.html"><a href="msgs.html"><i class="fa fa-check"></i><b>11</b> Message Policies</a>
<ul>
<li class="chapter" data-level="11.1" data-path="msgs.html"><a href="msgs.html#server-side-extension-6"><i class="fa fa-check"></i><b>11.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="11.1.1" data-path="msgs.html"><a href="msgs.html#msgs-gpme"><i class="fa fa-check"></i><b>11.1.1</b> Managing Message Policy via the GPME</a></li>
<li class="chapter" data-level="11.1.2" data-path="msgs.html"><a href="msgs.html#msgs-samba-tool"><i class="fa fa-check"></i><b>11.1.2</b> Managing Message Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="msgs.html"><a href="msgs.html#client-side-extension-7"><i class="fa fa-check"></i><b>11.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="pamaccess.html"><a href="pamaccess.html"><i class="fa fa-check"></i><b>12</b> PAM Access Policies</a>
<ul>
<li class="chapter" data-level="12.1" data-path="pamaccess.html"><a href="pamaccess.html#server-side-extension-7"><i class="fa fa-check"></i><b>12.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="pamaccess.html"><a href="pamaccess.html#managing-pam-access-policies-via-samba-tool"><i class="fa fa-check"></i><b>12.1.1</b> Managing PAM Access Policies via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="pamaccess.html"><a href="pamaccess.html#client-side-extension-8"><i class="fa fa-check"></i><b>12.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="certautoenroll.html"><a href="certautoenroll.html"><i class="fa fa-check"></i><b>13</b> Certificate Auto Enrollment Policy</a>
<ul>
<li class="chapter" data-level="13.1" data-path="certautoenroll.html"><a href="certautoenroll.html#server-side-extension-8"><i class="fa fa-check"></i><b>13.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="certautoenroll.html"><a href="certautoenroll.html#managing-certificate-auto-enrollment-via-the-gpme"><i class="fa fa-check"></i><b>13.1.1</b> Managing Certificate Auto Enrollment via the GPME</a></li>
<li class="chapter" data-level="13.1.2" data-path="certautoenroll.html"><a href="certautoenroll.html#certificate-templates"><i class="fa fa-check"></i><b>13.1.2</b> Certificate Templates</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="certautoenroll.html"><a href="certautoenroll.html#client-side-extension-9"><i class="fa fa-check"></i><b>13.2</b> Client Side Extension</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="certautoenroll.html"><a href="certautoenroll.html#trouble-shooting-certificates"><i class="fa fa-check"></i><b>13.2.1</b> Trouble Shooting Certificates</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="firefox.html"><a href="firefox.html"><i class="fa fa-check"></i><b>14</b> Firefox Policy</a>
<ul>
<li class="chapter" data-level="14.1" data-path="firefox.html"><a href="firefox.html#server-side-extension-9"><i class="fa fa-check"></i><b>14.1</b> Server Side Extension</a></li>
<li class="chapter" data-level="14.2" data-path="firefox.html"><a href="firefox.html#managing-firefox-policy-via-the-gpme"><i class="fa fa-check"></i><b>14.2</b> Managing Firefox Policy via the GPME</a></li>
<li class="chapter" data-level="14.3" data-path="firefox.html"><a href="firefox.html#client-side-extension-10"><i class="fa fa-check"></i><b>14.3</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="chrome.html"><a href="chrome.html"><i class="fa fa-check"></i><b>15</b> Chromium/Chrome Policy</a>
<ul>
<li class="chapter" data-level="15.1" data-path="chrome.html"><a href="chrome.html#server-side-extension-10"><i class="fa fa-check"></i><b>15.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="15.1.1" data-path="chrome.html"><a href="chrome.html#managing-chromium-policy-via-the-gpme"><i class="fa fa-check"></i><b>15.1.1</b> Managing Chromium Policy via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="chrome.html"><a href="chrome.html#client-side-extension-11"><i class="fa fa-check"></i><b>15.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="gnome.html"><a href="gnome.html"><i class="fa fa-check"></i><b>16</b> GNOME Settings Policy</a>
<ul>
<li class="chapter" data-level="16.1" data-path="gnome.html"><a href="gnome.html#server-side-extension-11"><i class="fa fa-check"></i><b>16.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="gnome.html"><a href="gnome.html#managing-gnome-settings-policy-via-the-gpme"><i class="fa fa-check"></i><b>16.1.1</b> Managing GNOME Settings Policy via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="gnome.html"><a href="gnome.html#client-side-extension-12"><i class="fa fa-check"></i><b>16.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="openssh.html"><a href="openssh.html"><i class="fa fa-check"></i><b>17</b> OpenSSH Policy</a>
<ul>
<li class="chapter" data-level="17.1" data-path="openssh.html"><a href="openssh.html#server-side-extension-12"><i class="fa fa-check"></i><b>17.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="17.1.1" data-path="openssh.html"><a href="openssh.html#managing-openssh-policy-via-samba-tool"><i class="fa fa-check"></i><b>17.1.1</b> Managing OpenSSH Policy via samba-tool</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="openssh.html"><a href="openssh.html#client-side-extension-13"><i class="fa fa-check"></i><b>17.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="firewalld.html"><a href="firewalld.html"><i class="fa fa-check"></i><b>18</b> Firewalld Policy</a>
<ul>
<li class="chapter" data-level="18.1" data-path="firewalld.html"><a href="firewalld.html#server-side-extension-13"><i class="fa fa-check"></i><b>18.1</b> Server Side Extension</a>
<ul>
<li class="chapter" data-level="18.1.1" data-path="firewalld.html"><a href="firewalld.html#managing-firewalld-policy-via-the-gpme"><i class="fa fa-check"></i><b>18.1.1</b> Managing Firewalld Policy via the GPME</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="firewalld.html"><a href="firewalld.html#client-side-extension-14"><i class="fa fa-check"></i><b>18.2</b> Client Side Extension</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html"><i class="fa fa-check"></i><b>19</b> Writing Group Policy Extensions</a>
<ul>
<li class="chapter" data-level="19.1" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#sse"><i class="fa fa-check"></i><b>19.1</b> Creating the Server Side Extension</a>
<ul>
<li class="chapter" data-level="19.1.1" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#admx"><i class="fa fa-check"></i><b>19.1.1</b> Administrative Templates</a></li>
<li class="chapter" data-level="19.1.2" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#samba-tool-gpo-manage"><i class="fa fa-check"></i><b>19.1.2</b> samba-tool gpo manage</a></li>
</ul></li>
<li class="chapter" data-level="19.2" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#cse"><i class="fa fa-check"></i><b>19.2</b> Creating the Client Side Extension</a>
<ul>
<li class="chapter" data-level="19.2.1" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#the-gp_ext-and-gp_applier-python-classes"><i class="fa fa-check"></i><b>19.2.1</b> The gp_ext and gp_applier Python Classes</a></li>
<li class="chapter" data-level="19.2.2" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#process-group-policy"><i class="fa fa-check"></i><b>19.2.2</b> Process Group Policy</a></li>
<li class="chapter" data-level="19.2.3" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#resultant-set-of-policy"><i class="fa fa-check"></i><b>19.2.3</b> Resultant Set of Policy</a></li>
<li class="chapter" data-level="19.2.4" data-path="writing-group-policy-extensions.html"><a href="writing-group-policy-extensions.html#registeringunregistering-a-client-side-extension"><i class="fa fa-check"></i><b>19.2.4</b> Registering/Unregistering a Client Side Extension</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="regpol.html"><a href="regpol.html"><i class="fa fa-check"></i><b>20</b> Modifying a Registry.pol File</a>
<ul>
<li class="chapter" data-level="20.1" data-path="regpol.html"><a href="regpol.html#using-samba-tool"><i class="fa fa-check"></i><b>20.1</b> Using samba-tool</a></li>
<li class="chapter" data-level="20.2" data-path="regpol.html"><a href="regpol.html#scripting-with-python"><i class="fa fa-check"></i><b>20.2</b> Scripting with python</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="install-admx.html"><a href="install-admx.html"><i class="fa fa-check"></i><b>21</b> Installing Administrative Templates</a>
<ul>
<li class="chapter" data-level="21.1" data-path="install-admx.html"><a href="install-admx.html#install-admx-samba"><i class="fa fa-check"></i><b>21.1</b> Install Samba ADMX Templates</a></li>
<li class="chapter" data-level="21.2" data-path="install-admx.html"><a href="install-admx.html#install-admx-firefox"><i class="fa fa-check"></i><b>21.2</b> Installing Firefox ADMX Templates</a></li>
<li class="chapter" data-level="21.3" data-path="install-admx.html"><a href="install-admx.html#install-admx-chromium"><i class="fa fa-check"></i><b>21.3</b> Installing Chromium ADMX Templates</a></li>
<li class="chapter" data-level="21.4" data-path="install-admx.html"><a href="install-admx.html#install-admx-windows"><i class="fa fa-check"></i><b>21.4</b> Installing Windows ADMX Templates</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Group Policy on Linux</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="writing-group-policy-extensions" class="section level1 hasAnchor" number="19">
<h1><span class="header-section-number">19</span> Writing Group Policy Extensions<a href="writing-group-policy-extensions.html#writing-group-policy-extensions" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The chapter will explain how to write a Group Policy Extension for Samba’s Winbind. Group Policy is a delivery mechanism for distributing system settings and company policies to machines joined to an Active Directory domain. Unix/Linux machines running Samba’s Winbind can also deploy these policies.</p>
<div id="sse" class="section level2 hasAnchor" number="19.1">
<h2><span class="header-section-number">19.1</span> Creating the Server Side Extension<a href="writing-group-policy-extensions.html#sse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="admx" class="section level3 hasAnchor" number="19.1.1">
<h3><span class="header-section-number">19.1.1</span> Administrative Templates<a href="writing-group-policy-extensions.html#admx" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The first step to deploying Group Policy is to create a Server Side Extension (SSE). There are multiple ways to create an SSE, but here we’ll only discuss Administrative Templates (ADMX). The purpose of the SSE is to deploy policies to the SYSVOL share. Theoretically, you could manually deploy any file (even plain text) to the SYSVOL and then write a Client Side Extension that parses it, but ADMX can be read and modified by the Group Policy Management Editor, which makes administration of policies simpler.</p>
<p>ADMX files are simply XML files which explain to the Group Policy Management Console how to display and store a policy in the SYSVOL. AMDX files always store policies in Registry.pol files. Samba provides a mechanism for parsing these, which we’ll discuss later.</p>
<p>Below is a simple example of an ADMX template, and it’s corresponding ADML file.</p>
<p><strong>samba.admx:</strong></p>
<div class="sourceCode" id="cb101"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb101-1"><a href="writing-group-policy-extensions.html#cb101-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">policyDefinitions</span><span class="ot"> revision=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> schemaVersion=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb101-2"><a href="writing-group-policy-extensions.html#cb101-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">policyNamespaces</span>&gt;</span>
<span id="cb101-3"><a href="writing-group-policy-extensions.html#cb101-3" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">using</span><span class="ot"> prefix=</span><span class="st">&quot;windows&quot;</span></span>
<span id="cb101-4"><a href="writing-group-policy-extensions.html#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="ot">           namespace=</span><span class="st">&quot;Microsoft.Policies.Windows&quot;</span> /&gt;</span>
<span id="cb101-5"><a href="writing-group-policy-extensions.html#cb101-5" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">policyNamespaces</span>&gt;</span>
<span id="cb101-6"><a href="writing-group-policy-extensions.html#cb101-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">supersededAdm</span><span class="ot"> fileName=</span><span class="st">&quot;&quot;</span> /&gt;</span>
<span id="cb101-7"><a href="writing-group-policy-extensions.html#cb101-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">resources</span><span class="ot"> minRequiredRevision=</span><span class="st">&quot;1.0&quot;</span> /&gt;</span>
<span id="cb101-8"><a href="writing-group-policy-extensions.html#cb101-8" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">categories</span>&gt;</span>
<span id="cb101-9"><a href="writing-group-policy-extensions.html#cb101-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">category</span><span class="ot"> name=</span><span class="st">&quot;CAT_SAMBA&quot;</span></span>
<span id="cb101-10"><a href="writing-group-policy-extensions.html#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="ot">              displayName=</span><span class="st">&quot;$(string.CAT_SAMBA)&quot;</span> /&gt;</span>
<span id="cb101-11"><a href="writing-group-policy-extensions.html#cb101-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">category</span><span class="ot"> name=</span><span class="st">&quot;CAT_UNIX_SETTINGS&quot;</span></span>
<span id="cb101-12"><a href="writing-group-policy-extensions.html#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="ot">              displayName=</span><span class="st">&quot;$(string.CAT_UNIX_SETTINGS)&quot;</span>&gt;</span>
<span id="cb101-13"><a href="writing-group-policy-extensions.html#cb101-13" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">parentCategory</span><span class="ot"> ref=</span><span class="st">&quot;CAT_SAMBA&quot;</span> /&gt;</span>
<span id="cb101-14"><a href="writing-group-policy-extensions.html#cb101-14" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">category</span>&gt;</span>
<span id="cb101-15"><a href="writing-group-policy-extensions.html#cb101-15" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">categories</span>&gt;</span>
<span id="cb101-16"><a href="writing-group-policy-extensions.html#cb101-16" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">policies</span>&gt;</span>
<span id="cb101-17"><a href="writing-group-policy-extensions.html#cb101-17" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">policy</span><span class="ot"> name=</span><span class="st">&quot;POL_DAILY_SCRIPTS&quot;</span><span class="ot"> class=</span><span class="st">&quot;Machine&quot;</span></span>
<span id="cb101-18"><a href="writing-group-policy-extensions.html#cb101-18" aria-hidden="true" tabindex="-1"></a><span class="ot">            displayName=</span><span class="st">&quot;$(string.POL_DAILY_SCRIPTS)&quot;</span></span>
<span id="cb101-19"><a href="writing-group-policy-extensions.html#cb101-19" aria-hidden="true" tabindex="-1"></a><span class="ot">        explainText=</span><span class="st">&quot;$(string.POL_DAILY_SCRIPTS_Help)&quot;</span></span>
<span id="cb101-20"><a href="writing-group-policy-extensions.html#cb101-20" aria-hidden="true" tabindex="-1"></a><span class="ot">        presentation=</span><span class="st">&quot;$(presentation.POL_DAILY_SCRIPTS)&quot;</span></span>
<span id="cb101-21"><a href="writing-group-policy-extensions.html#cb101-21" aria-hidden="true" tabindex="-1"></a><span class="ot">        key=</span><span class="st">&quot;Software\Policies\Samba\Unix Settings&quot;</span>&gt;</span>
<span id="cb101-22"><a href="writing-group-policy-extensions.html#cb101-22" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">parentCategory</span><span class="ot"> ref=</span><span class="st">&quot;CAT_UNIX_SETTINGS&quot;</span> /&gt;</span>
<span id="cb101-23"><a href="writing-group-policy-extensions.html#cb101-23" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">supportedOn</span><span class="ot"> ref=</span><span class="st">&quot;windows:SUPPORTED_WindowsVista&quot;</span> /&gt;</span>
<span id="cb101-24"><a href="writing-group-policy-extensions.html#cb101-24" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">elements</span>&gt;</span>
<span id="cb101-25"><a href="writing-group-policy-extensions.html#cb101-25" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">list</span><span class="ot"> id=</span><span class="st">&quot;LST_DAILY_SCRIPTS&quot;</span></span>
<span id="cb101-26"><a href="writing-group-policy-extensions.html#cb101-26" aria-hidden="true" tabindex="-1"></a><span class="ot">          key=</span><span class="st">&quot;Software\Policies\Samba\</span></span>
<span id="cb101-27"><a href="writing-group-policy-extensions.html#cb101-27" aria-hidden="true" tabindex="-1"></a><span class="st">               Unix Settings\Daily Scripts&quot;</span></span>
<span id="cb101-28"><a href="writing-group-policy-extensions.html#cb101-28" aria-hidden="true" tabindex="-1"></a><span class="ot">          valueName=</span><span class="st">&quot;Daily Scripts&quot;</span> /&gt;</span>
<span id="cb101-29"><a href="writing-group-policy-extensions.html#cb101-29" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">elements</span>&gt;</span>
<span id="cb101-30"><a href="writing-group-policy-extensions.html#cb101-30" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">policy</span>&gt;</span>
<span id="cb101-31"><a href="writing-group-policy-extensions.html#cb101-31" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">policies</span>&gt;</span>
<span id="cb101-32"><a href="writing-group-policy-extensions.html#cb101-32" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">policyDefinitions</span>&gt;</span></code></pre></div>
<p><strong>en-US/samba.adml:</strong></p>
<div class="sourceCode" id="cb102"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb102-1"><a href="writing-group-policy-extensions.html#cb102-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">policyDefinitionResources</span><span class="ot"> revision=</span><span class="st">&quot;1.0&quot;</span><span class="ot"> schemaVersion=</span><span class="st">&quot;1.0&quot;</span>&gt;</span>
<span id="cb102-2"><a href="writing-group-policy-extensions.html#cb102-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">displayName</span>&gt;</span>
<span id="cb102-3"><a href="writing-group-policy-extensions.html#cb102-3" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">displayName</span>&gt;</span>
<span id="cb102-4"><a href="writing-group-policy-extensions.html#cb102-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">description</span>&gt;</span>
<span id="cb102-5"><a href="writing-group-policy-extensions.html#cb102-5" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">description</span>&gt;</span>
<span id="cb102-6"><a href="writing-group-policy-extensions.html#cb102-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">resources</span>&gt;</span>
<span id="cb102-7"><a href="writing-group-policy-extensions.html#cb102-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">stringTable</span>&gt;</span>
<span id="cb102-8"><a href="writing-group-policy-extensions.html#cb102-8" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;CAT_SAMBA&quot;</span>&gt;Samba&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb102-9"><a href="writing-group-policy-extensions.html#cb102-9" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;CAT_UNIX_SETTINGS&quot;</span>&gt;Unix Settings&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb102-10"><a href="writing-group-policy-extensions.html#cb102-10" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;POL_DAILY_SCRIPTS&quot;</span>&gt;Daily Scripts&lt;/<span class="kw">string</span>&gt;</span>
<span id="cb102-11"><a href="writing-group-policy-extensions.html#cb102-11" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">string</span><span class="ot"> id=</span><span class="st">&quot;POL_DAILY_SCRIPTS_Help&quot;</span>&gt;</span>
<span id="cb102-12"><a href="writing-group-policy-extensions.html#cb102-12" aria-hidden="true" tabindex="-1"></a>        This policy setting allows you to execute commands, </span>
<span id="cb102-13"><a href="writing-group-policy-extensions.html#cb102-13" aria-hidden="true" tabindex="-1"></a>        either local or on remote storage, daily.</span>
<span id="cb102-14"><a href="writing-group-policy-extensions.html#cb102-14" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">string</span>&gt;</span>
<span id="cb102-15"><a href="writing-group-policy-extensions.html#cb102-15" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">stringTable</span>&gt;</span>
<span id="cb102-16"><a href="writing-group-policy-extensions.html#cb102-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">presentationTable</span>&gt;</span>
<span id="cb102-17"><a href="writing-group-policy-extensions.html#cb102-17" aria-hidden="true" tabindex="-1"></a>      &lt;<span class="kw">presentation</span><span class="ot"> id=</span><span class="st">&quot;POL_DAILY_SCRIPTS&quot;</span>&gt;</span>
<span id="cb102-18"><a href="writing-group-policy-extensions.html#cb102-18" aria-hidden="true" tabindex="-1"></a>        &lt;<span class="kw">listBox</span><span class="ot"> refId=</span><span class="st">&quot;LST_DAILY_SCRIPTS&quot;</span>&gt;</span>
<span id="cb102-19"><a href="writing-group-policy-extensions.html#cb102-19" aria-hidden="true" tabindex="-1"></a>      Script and arguments</span>
<span id="cb102-20"><a href="writing-group-policy-extensions.html#cb102-20" aria-hidden="true" tabindex="-1"></a>        &lt;/<span class="kw">listBox</span>&gt;</span>
<span id="cb102-21"><a href="writing-group-policy-extensions.html#cb102-21" aria-hidden="true" tabindex="-1"></a>      &lt;/<span class="kw">presentation</span>&gt;</span>
<span id="cb102-22"><a href="writing-group-policy-extensions.html#cb102-22" aria-hidden="true" tabindex="-1"></a>    &lt;/<span class="kw">presentationTable</span>&gt;</span>
<span id="cb102-23"><a href="writing-group-policy-extensions.html#cb102-23" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">resources</span>&gt;</span>
<span id="cb102-24"><a href="writing-group-policy-extensions.html#cb102-24" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">policyDefinitionResources</span>&gt;</span></code></pre></div>
<p>The meaning of the various tags are explained in Microsoft’s Group Policy documentation at <a href="https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/admx-schema" class="uri">https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/admx-schema</a>. Before the endless documentation and confusing XML scares you away, be aware there is an easier way!</p>
<div id="admx-migrator" class="section level4 hasAnchor" number="19.1.1.1">
<h4><span class="header-section-number">19.1.1.1</span> ADMX Migrator<a href="writing-group-policy-extensions.html#admx-migrator" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>FullArmor created the ADMX Migrator to simplify the shift for system administrators from the old ADM policy templates to ADMX. Fortunately, this tool also serves our purpose for assisting us in easily creating these templates for our SSE. Unfortunately, the tool hasn’t seen any development in the past 8 years, and wont run in Windows 10 (or any Unix/Linux platform, for that matter). I had to dredge up a Windows 7 VM in order to install and use the tool.</p>
<div id="creating-the-administrative-template" class="section level5 hasAnchor" number="19.1.1.1.1">
<h5><span class="header-section-number">19.1.1.1.1</span> Creating the Administrative Template<a href="writing-group-policy-extensions.html#creating-the-administrative-template" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<ol style="list-style-type: decimal">
<li><p>Open ADMX Migrator</p></li>
<li><p>Right click on ADMX Templates in the left tree view, and click New Template.</p></li>
<li><p>Give your template a name, and click OK.</p></li>
<li><p>Right click on the new template in the left tree view, and click New Category.</p></li>
</ol>
<p><img src="ext-images/new-category.png" width="70%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Give the Category a name. This name will be displayed in the Group Policy Management Editor under Administrative Templates. You can choose to nest template under an existing category, or simply add it as a new root.</li>
</ol>
<div id="info" style="color: green;">
<p>Note: You can also add sub-categories under this category. After clicking OK, right click the category you created and select New Category.</p>
</div>
<ol start="6" style="list-style-type: decimal">
<li>Next, create your policy by right clicking on your new category, and selecting New Policy Setting.</li>
</ol>
<p><img src="ext-images/new-policy.png" width="70%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li><p>Because we’ll be applying these settings to a Linux machine, the Registry fields are mostly meaningless, but they are required. Your policies will be stored under these keys on the SYSVOL in the Registry.pol file. Choose some sensible Registry Key, such as ‘Software\Policies\Samba\Unix Settings’, and a Registry Value Name, such as ‘Daily Scripts’ (these are the values used for Samba’s cron.daily policy). The Display Name is the name that will be displayed for this policy in the Group Policy Management Editor. I usually make this the same as the Registry Value Name, but it doesn’t need to be.</p></li>
<li><p>Select whether this policy will be applied to a Machine, a User, or to Both in the Class field. In our example, we could potentially set Both, then our Client Side Extension would need to handle both cron.daily scripts (the Machine) and also User crontab entries. Click OK for your policy to be created.</p></li>
<li><p>Your new policy will appear in the middle list view. Highlight it, and you will see a number of tabs below for configuring the policy.</p></li>
</ol>
<p><img src="ext-images/new-policy-list-view.png" width="70%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li><p>Select the Values tab and set the Enabled Value Type. In this case, we’ll use String, since our cron commands will be saved to the Registry.pol as a string. In the Value field, you can set a default enabled value (this is optional).</p></li>
<li><p>Select the Presentation tab, right click in the Elements view, and click New Element &gt; ListBox (or a different presentation, depending on the policy). If you look at the samba.adml file from the previous section, you’ll notice that the presentationTable contains a listBox item. That’s what we’re creating here.</p></li>
<li><p>Choose an element Label, this will be the name for the list displayed in the Group Policy Management Editor.</p></li>
<li><p>Choose a Registry Key. This will be pre-populated with the parent Registry Key you gave when creating the policy. Append something to the key to make it unique. We’ll use ‘Software\Policies\Samba\Unix Settings\Daily Scripts’ for our cron.daily policy.</p></li>
<li><p>Navigate to the Explain tab, and add an explanation of what this policy is and what it does. This will be displayed to users in the Group Policy Management Editor.</p></li>
<li><p>Now right click on your template name in the left tree, and select Save As.</p></li>
<li><p>Finally, you’ll need to deploy your new policy definition to the SYSVOL. It should be saved to the Policies\PolicyDefinitions (the Group Policy Central Store) directory. These instructions from Microsoft can assist you in setting up your Group Policy Central Store.</p></li>
</ol>
<p><img src="ext-images/sse.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="samba-tool-gpo-manage" class="section level3 hasAnchor" number="19.1.2">
<h3><span class="header-section-number">19.1.2</span> samba-tool gpo manage<a href="writing-group-policy-extensions.html#samba-tool-gpo-manage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>samba-tool gpo manage</code> command is a tool provided by the Samba team for managing Group Policy Objects (GPOs). This command provides a number of subcommands that allow you to add, remove, and list policies within a GPO.</p>
<p>Adding subcommands to <code>samba-tool gpo manage</code> is one way to create a Server Side Extension (SSE) for Group Policy. Each <code>samba-tool gpo manage</code> command generally provides 3 subcommands for each policy; add, remove, and list. These subcommands allow you to add new policies to a GPO, remove existing policies from a GPO, and list the policies that are currently configured in a GPO.</p>
<p>Group Policy SSEs should be added to <code>samba-tool</code> in the <code>python/samba/netcmd/gpo.py</code> file.</p>
<div id="subcommands" class="section level4 hasAnchor" number="19.1.2.1">
<h4><span class="header-section-number">19.1.2.1</span> Subcommands<a href="writing-group-policy-extensions.html#subcommands" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>To add python subcommands using the <code>SuperCommand</code> class, you will need to create a new class that inherits from the <code>SuperCommand</code> class, and define a subcommands attribute that lists the subcommands that are supported by your command. The subcommands attribute will be a dictionary containing keys with new command names, paired with instances of <code>Command</code> classes which implement the command.</p>
<p>For example:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="writing-group-policy-extensions.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> cmd_scripts(SuperCommand):</span>
<span id="cb103-2"><a href="writing-group-policy-extensions.html#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Manage Scripts Group Policy Objects&quot;&quot;&quot;</span></span>
<span id="cb103-3"><a href="writing-group-policy-extensions.html#cb103-3" aria-hidden="true" tabindex="-1"></a>    subcommands <span class="op">=</span> {}</span>
<span id="cb103-4"><a href="writing-group-policy-extensions.html#cb103-4" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;add&quot;</span>] <span class="op">=</span> cmd_add_script()</span>
<span id="cb103-5"><a href="writing-group-policy-extensions.html#cb103-5" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;list&quot;</span>] <span class="op">=</span> cmd_list_script()</span>
<span id="cb103-6"><a href="writing-group-policy-extensions.html#cb103-6" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;remove&quot;</span>] <span class="op">=</span> cmd_remove_script()</span></code></pre></div>
<p>Your <code>SuperCommand</code> will then need to be tied into an existing <code>samba-tool</code> command, for example:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="writing-group-policy-extensions.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> cmd_manage(SuperCommand):</span>
<span id="cb104-2"><a href="writing-group-policy-extensions.html#cb104-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Manage Group Policy Objects&quot;&quot;&quot;</span></span>
<span id="cb104-3"><a href="writing-group-policy-extensions.html#cb104-3" aria-hidden="true" tabindex="-1"></a>    subcommands <span class="op">=</span> {}</span>
<span id="cb104-4"><a href="writing-group-policy-extensions.html#cb104-4" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;sudoers&quot;</span>] <span class="op">=</span> cmd_sudoers()</span>
<span id="cb104-5"><a href="writing-group-policy-extensions.html#cb104-5" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;security&quot;</span>] <span class="op">=</span> cmd_security()</span>
<span id="cb104-6"><a href="writing-group-policy-extensions.html#cb104-6" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;smb_conf&quot;</span>] <span class="op">=</span> cmd_smb_conf()</span>
<span id="cb104-7"><a href="writing-group-policy-extensions.html#cb104-7" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;symlink&quot;</span>] <span class="op">=</span> cmd_symlink()</span>
<span id="cb104-8"><a href="writing-group-policy-extensions.html#cb104-8" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;files&quot;</span>] <span class="op">=</span> cmd_files()</span>
<span id="cb104-9"><a href="writing-group-policy-extensions.html#cb104-9" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;openssh&quot;</span>] <span class="op">=</span> cmd_openssh()</span>
<span id="cb104-10"><a href="writing-group-policy-extensions.html#cb104-10" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;motd&quot;</span>] <span class="op">=</span> cmd_motd()</span>
<span id="cb104-11"><a href="writing-group-policy-extensions.html#cb104-11" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;issue&quot;</span>] <span class="op">=</span> cmd_issue()</span>
<span id="cb104-12"><a href="writing-group-policy-extensions.html#cb104-12" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;access&quot;</span>] <span class="op">=</span> cmd_access()</span>
<span id="cb104-13"><a href="writing-group-policy-extensions.html#cb104-13" aria-hidden="true" tabindex="-1"></a>    subcommands[<span class="st">&quot;scripts&quot;</span>] <span class="op">=</span> cmd_scripts()</span></code></pre></div>
<p>Notice that the <code>cmd_scripts</code> <code>SuperCommand</code> from earlier has been appended to the <code>cmd_manage</code> list of <code>subcommands</code>.</p>
<div id="implementing-an-add-subcommand" class="section level5 hasAnchor" number="19.1.2.1.1">
<h5><span class="header-section-number">19.1.2.1.1</span> Implementing an Add Subcommand<a href="writing-group-policy-extensions.html#implementing-an-add-subcommand" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To write a command that adds a new policy to a Group Policy Object (GPO), you will need to create a class that inherits from the Command class provided by the samba.netcmd module, and define a run method that takes a series of arguments and options, and contains the code that will be executed when the command is run.</p>
<p>The run method should begin by connecting to a Domain Controller (DC) using the <code>smb_connection</code> function defined in <code>python/samba/netcmd/gpo.py</code>. It can then retrieve the data from the GPO’s Registry.pol file using the loadfile method of the connection object returned by the <code>smb_connection</code> function, or create a new file object if the file does not exist.</p>
<p>Next, the method can parse the data in the <code>Registry.pol</code> file using the <code>ndr_unpack</code> function from the <code>samba.ndr</code> module, which will return a file object representing the data in the file. We will then add a key to the list of entries in <code>Registry.pol</code> file object.</p>
<p>Finally, we save the modified file object back to the GPO’s <code>Registry.pol</code> file on the DC using the savefile method of the connection object.</p>
<p>The class should also define a synopsis attribute, which provides a brief summary of the command.</p>
<p>Here is an example of what it might look:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="writing-group-policy-extensions.html#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> cmd_add_script(Command):</span>
<span id="cb105-2"><a href="writing-group-policy-extensions.html#cb105-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Adds Script Group Policy to the sysvol</span></span>
<span id="cb105-3"><a href="writing-group-policy-extensions.html#cb105-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-4"><a href="writing-group-policy-extensions.html#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="co">This command adds a script policy to the sysvol.</span></span>
<span id="cb105-5"><a href="writing-group-policy-extensions.html#cb105-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-6"><a href="writing-group-policy-extensions.html#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="co">Example:</span></span>
<span id="cb105-7"><a href="writing-group-policy-extensions.html#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="co">samba-tool gpo manage scripts add </span><span class="ch">\</span></span>
<span id="cb105-8"><a href="writing-group-policy-extensions.html#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="co"> {31B2F340-016D-11D2-945F-00C04FB984F9} MACHINE daily </span><span class="ch">\</span></span>
<span id="cb105-9"><a href="writing-group-policy-extensions.html#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="co"> test_script.sh &#39;</span><span class="ch">\\</span><span class="co">-n </span><span class="ch">\\</span><span class="co">-p all&#39;</span></span>
<span id="cb105-10"><a href="writing-group-policy-extensions.html#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="writing-group-policy-extensions.html#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="co">policy_class is defined as either MACHINE or USER.</span></span>
<span id="cb105-12"><a href="writing-group-policy-extensions.html#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="co">freq is defined as either Daily, Monthly, Weekly, or Hourly.</span></span>
<span id="cb105-13"><a href="writing-group-policy-extensions.html#cb105-13" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb105-14"><a href="writing-group-policy-extensions.html#cb105-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-15"><a href="writing-group-policy-extensions.html#cb105-15" aria-hidden="true" tabindex="-1"></a>    synopsis <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%prog</span><span class="st"> &lt;gpo&gt; &lt;policy_class&gt; &lt;freq&gt; &lt;script&gt; &quot;</span></span>
<span id="cb105-16"><a href="writing-group-policy-extensions.html#cb105-16" aria-hidden="true" tabindex="-1"></a>               <span class="co">&quot;[args] [options]&quot;</span></span>
<span id="cb105-17"><a href="writing-group-policy-extensions.html#cb105-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-18"><a href="writing-group-policy-extensions.html#cb105-18" aria-hidden="true" tabindex="-1"></a>    takes_optiongroups <span class="op">=</span> {</span>
<span id="cb105-19"><a href="writing-group-policy-extensions.html#cb105-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sambaopts&quot;</span>: options.SambaOptions,</span>
<span id="cb105-20"><a href="writing-group-policy-extensions.html#cb105-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;versionopts&quot;</span>: options.VersionOptions,</span>
<span id="cb105-21"><a href="writing-group-policy-extensions.html#cb105-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;credopts&quot;</span>: options.CredentialsOptions,</span>
<span id="cb105-22"><a href="writing-group-policy-extensions.html#cb105-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb105-23"><a href="writing-group-policy-extensions.html#cb105-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-24"><a href="writing-group-policy-extensions.html#cb105-24" aria-hidden="true" tabindex="-1"></a>    takes_options <span class="op">=</span> [</span>
<span id="cb105-25"><a href="writing-group-policy-extensions.html#cb105-25" aria-hidden="true" tabindex="-1"></a>        Option(<span class="st">&quot;-H&quot;</span>, <span class="st">&quot;--URL&quot;</span>,</span>
<span id="cb105-26"><a href="writing-group-policy-extensions.html#cb105-26" aria-hidden="true" tabindex="-1"></a>               <span class="bu">help</span><span class="op">=</span><span class="st">&quot;LDB URL for database or target server&quot;</span>,</span>
<span id="cb105-27"><a href="writing-group-policy-extensions.html#cb105-27" aria-hidden="true" tabindex="-1"></a>           <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, metavar<span class="op">=</span><span class="st">&quot;URL&quot;</span>, dest<span class="op">=</span><span class="st">&quot;H&quot;</span>),</span>
<span id="cb105-28"><a href="writing-group-policy-extensions.html#cb105-28" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb105-29"><a href="writing-group-policy-extensions.html#cb105-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-30"><a href="writing-group-policy-extensions.html#cb105-30" aria-hidden="true" tabindex="-1"></a>    takes_args <span class="op">=</span> [<span class="st">&quot;gpo&quot;</span>, <span class="st">&quot;policy_class&quot;</span>, <span class="st">&quot;freq&quot;</span>, <span class="st">&quot;script&quot;</span>,</span>
<span id="cb105-31"><a href="writing-group-policy-extensions.html#cb105-31" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;args?&quot;</span>]</span>
<span id="cb105-32"><a href="writing-group-policy-extensions.html#cb105-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-33"><a href="writing-group-policy-extensions.html#cb105-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>, gpo, policy_class, freq, script, args<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb105-34"><a href="writing-group-policy-extensions.html#cb105-34" aria-hidden="true" tabindex="-1"></a>            H<span class="op">=</span><span class="va">None</span>, sambaopts<span class="op">=</span><span class="va">None</span>, credopts<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb105-35"><a href="writing-group-policy-extensions.html#cb105-35" aria-hidden="true" tabindex="-1"></a>        versionopts<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb105-36"><a href="writing-group-policy-extensions.html#cb105-36" aria-hidden="true" tabindex="-1"></a>        policy_class <span class="op">=</span> policy_class.upper()</span>
<span id="cb105-37"><a href="writing-group-policy-extensions.html#cb105-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> policy_class <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;MACHINE&#39;</span>, <span class="st">&#39;USER&#39;</span>]:</span>
<span id="cb105-38"><a href="writing-group-policy-extensions.html#cb105-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> CommandError(<span class="st">&quot;&#39;</span><span class="sc">%s</span><span class="st">&#39; is not a valid policy_class.&quot;</span></span>
<span id="cb105-39"><a href="writing-group-policy-extensions.html#cb105-39" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; Choose from MACHINE or USER&quot;</span> <span class="op">%</span> policy_class)</span>
<span id="cb105-40"><a href="writing-group-policy-extensions.html#cb105-40" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> freq.title()</span>
<span id="cb105-41"><a href="writing-group-policy-extensions.html#cb105-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> freq <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;Daily&#39;</span>, <span class="st">&#39;Monthly&#39;</span>, <span class="st">&#39;Weekly&#39;</span>, <span class="st">&#39;Hourly&#39;</span>]:</span>
<span id="cb105-42"><a href="writing-group-policy-extensions.html#cb105-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> CommandError(<span class="st">&quot;&#39;</span><span class="sc">%s</span><span class="st">&#39; is not a valid frequency. &quot;</span></span>
<span id="cb105-43"><a href="writing-group-policy-extensions.html#cb105-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Choose from Daily, Monthly, Weekly, or &quot;</span></span>
<span id="cb105-44"><a href="writing-group-policy-extensions.html#cb105-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Hourly&quot;</span> <span class="op">%</span> freq)</span>
<span id="cb105-45"><a href="writing-group-policy-extensions.html#cb105-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-46"><a href="writing-group-policy-extensions.html#cb105-46" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lp <span class="op">=</span> sambaopts.get_loadparm()</span>
<span id="cb105-47"><a href="writing-group-policy-extensions.html#cb105-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.creds <span class="op">=</span> credopts.get_credentials(<span class="va">self</span>.lp,</span>
<span id="cb105-48"><a href="writing-group-policy-extensions.html#cb105-48" aria-hidden="true" tabindex="-1"></a>                                          fallback_machine<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb105-49"><a href="writing-group-policy-extensions.html#cb105-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-50"><a href="writing-group-policy-extensions.html#cb105-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(script):</span>
<span id="cb105-51"><a href="writing-group-policy-extensions.html#cb105-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> CommandError(</span>
<span id="cb105-52"><a href="writing-group-policy-extensions.html#cb105-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Script &#39;</span><span class="sc">%s</span><span class="st">&#39; does not exist&quot;</span> <span class="op">%</span> script)</span>
<span id="cb105-53"><a href="writing-group-policy-extensions.html#cb105-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-54"><a href="writing-group-policy-extensions.html#cb105-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to know writable DC to setup SMB connection</span></span>
<span id="cb105-55"><a href="writing-group-policy-extensions.html#cb105-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> H <span class="kw">and</span> H.startswith(<span class="st">&#39;ldap://&#39;</span>):</span>
<span id="cb105-56"><a href="writing-group-policy-extensions.html#cb105-56" aria-hidden="true" tabindex="-1"></a>            dc_hostname <span class="op">=</span> H[<span class="dv">7</span>:]</span>
<span id="cb105-57"><a href="writing-group-policy-extensions.html#cb105-57" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.url <span class="op">=</span> H</span>
<span id="cb105-58"><a href="writing-group-policy-extensions.html#cb105-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb105-59"><a href="writing-group-policy-extensions.html#cb105-59" aria-hidden="true" tabindex="-1"></a>            dc_hostname <span class="op">=</span> netcmd_finddc(<span class="va">self</span>.lp, <span class="va">self</span>.creds)</span>
<span id="cb105-60"><a href="writing-group-policy-extensions.html#cb105-60" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.url <span class="op">=</span> dc_url(<span class="va">self</span>.lp, <span class="va">self</span>.creds, dc<span class="op">=</span>dc_hostname)</span>
<span id="cb105-61"><a href="writing-group-policy-extensions.html#cb105-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-62"><a href="writing-group-policy-extensions.html#cb105-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SMB connect to DC</span></span>
<span id="cb105-63"><a href="writing-group-policy-extensions.html#cb105-63" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> smb_connection(dc_hostname,</span>
<span id="cb105-64"><a href="writing-group-policy-extensions.html#cb105-64" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;sysvol&#39;</span>,</span>
<span id="cb105-65"><a href="writing-group-policy-extensions.html#cb105-65" aria-hidden="true" tabindex="-1"></a>                              lp<span class="op">=</span><span class="va">self</span>.lp,</span>
<span id="cb105-66"><a href="writing-group-policy-extensions.html#cb105-66" aria-hidden="true" tabindex="-1"></a>                              creds<span class="op">=</span><span class="va">self</span>.creds)</span>
<span id="cb105-67"><a href="writing-group-policy-extensions.html#cb105-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-68"><a href="writing-group-policy-extensions.html#cb105-68" aria-hidden="true" tabindex="-1"></a>        realm <span class="op">=</span> <span class="va">self</span>.lp.get(<span class="st">&#39;realm&#39;</span>)</span>
<span id="cb105-69"><a href="writing-group-policy-extensions.html#cb105-69" aria-hidden="true" tabindex="-1"></a>        pol_file <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span>.join([realm.lower(), <span class="st">&#39;Policies&#39;</span>, gpo,</span>
<span id="cb105-70"><a href="writing-group-policy-extensions.html#cb105-70" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Registry.pol&#39;</span> <span class="op">%</span> policy_class])</span>
<span id="cb105-71"><a href="writing-group-policy-extensions.html#cb105-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb105-72"><a href="writing-group-policy-extensions.html#cb105-72" aria-hidden="true" tabindex="-1"></a>            pol_data <span class="op">=</span> ndr_unpack(preg.<span class="bu">file</span>,</span>
<span id="cb105-73"><a href="writing-group-policy-extensions.html#cb105-73" aria-hidden="true" tabindex="-1"></a>                                  conn.loadfile(pol_file))</span>
<span id="cb105-74"><a href="writing-group-policy-extensions.html#cb105-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> NTSTATUSError <span class="im">as</span> e:</span>
<span id="cb105-75"><a href="writing-group-policy-extensions.html#cb105-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> e.args[<span class="dv">0</span>] <span class="kw">in</span> [NT_STATUS_OBJECT_NAME_INVALID,</span>
<span id="cb105-76"><a href="writing-group-policy-extensions.html#cb105-76" aria-hidden="true" tabindex="-1"></a>                                 NT_STATUS_OBJECT_NAME_NOT_FOUND,</span>
<span id="cb105-77"><a href="writing-group-policy-extensions.html#cb105-77" aria-hidden="true" tabindex="-1"></a>                                 NT_STATUS_OBJECT_PATH_NOT_FOUND]:</span>
<span id="cb105-78"><a href="writing-group-policy-extensions.html#cb105-78" aria-hidden="true" tabindex="-1"></a>                <span class="co"># The file doesn&#39;t exist, so create it</span></span>
<span id="cb105-79"><a href="writing-group-policy-extensions.html#cb105-79" aria-hidden="true" tabindex="-1"></a>                pol_data <span class="op">=</span> preg.<span class="bu">file</span>()</span>
<span id="cb105-80"><a href="writing-group-policy-extensions.html#cb105-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> e.args[<span class="dv">0</span>] <span class="op">==</span> NT_STATUS_ACCESS_DENIED:</span>
<span id="cb105-81"><a href="writing-group-policy-extensions.html#cb105-81" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> CommandError(<span class="st">&quot;The authenticated user does &quot;</span></span>
<span id="cb105-82"><a href="writing-group-policy-extensions.html#cb105-82" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;not have sufficient privileges&quot;</span>)</span>
<span id="cb105-83"><a href="writing-group-policy-extensions.html#cb105-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb105-84"><a href="writing-group-policy-extensions.html#cb105-84" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span></span>
<span id="cb105-85"><a href="writing-group-policy-extensions.html#cb105-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-86"><a href="writing-group-policy-extensions.html#cb105-86" aria-hidden="true" tabindex="-1"></a>        reg_key <span class="op">=</span> <span class="st">b&#39;Software</span><span class="ch">\\</span><span class="st">Policies</span><span class="ch">\\</span><span class="st">Samba</span><span class="ch">\\</span><span class="st">Unix Settings&#39;</span></span>
<span id="cb105-87"><a href="writing-group-policy-extensions.html#cb105-87" aria-hidden="true" tabindex="-1"></a>        keyname <span class="op">=</span> <span class="st">b&#39;%s</span><span class="ch">\\</span><span class="st">%s Scripts&#39;</span> <span class="op">%</span> (reg_key, get_bytes(freq))</span>
<span id="cb105-88"><a href="writing-group-policy-extensions.html#cb105-88" aria-hidden="true" tabindex="-1"></a>        entry <span class="op">=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="st"> </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (script,</span>
<span id="cb105-89"><a href="writing-group-policy-extensions.html#cb105-89" aria-hidden="true" tabindex="-1"></a>                           args <span class="cf">if</span> args <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb105-90"><a href="writing-group-policy-extensions.html#cb105-90" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> preg.entry()</span>
<span id="cb105-91"><a href="writing-group-policy-extensions.html#cb105-91" aria-hidden="true" tabindex="-1"></a>        e.keyname <span class="op">=</span> keyname</span>
<span id="cb105-92"><a href="writing-group-policy-extensions.html#cb105-92" aria-hidden="true" tabindex="-1"></a>        e.valuename <span class="op">=</span> reg_key</span>
<span id="cb105-93"><a href="writing-group-policy-extensions.html#cb105-93" aria-hidden="true" tabindex="-1"></a>        e.<span class="bu">type</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb105-94"><a href="writing-group-policy-extensions.html#cb105-94" aria-hidden="true" tabindex="-1"></a>        e.data <span class="op">=</span> get_bytes(entry)</span>
<span id="cb105-95"><a href="writing-group-policy-extensions.html#cb105-95" aria-hidden="true" tabindex="-1"></a>        entries <span class="op">=</span> <span class="bu">list</span>(pol_data.entries)</span>
<span id="cb105-96"><a href="writing-group-policy-extensions.html#cb105-96" aria-hidden="true" tabindex="-1"></a>        entries.append(e)</span>
<span id="cb105-97"><a href="writing-group-policy-extensions.html#cb105-97" aria-hidden="true" tabindex="-1"></a>        pol_data.num_entries <span class="op">=</span> <span class="bu">len</span>(entries)</span>
<span id="cb105-98"><a href="writing-group-policy-extensions.html#cb105-98" aria-hidden="true" tabindex="-1"></a>        pol_data.entries <span class="op">=</span> entries</span>
<span id="cb105-99"><a href="writing-group-policy-extensions.html#cb105-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-100"><a href="writing-group-policy-extensions.html#cb105-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb105-101"><a href="writing-group-policy-extensions.html#cb105-101" aria-hidden="true" tabindex="-1"></a>            conn.savefile(pol_file, ndr_pack(pol_data))</span>
<span id="cb105-102"><a href="writing-group-policy-extensions.html#cb105-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> NTSTATUSError <span class="im">as</span> e:</span>
<span id="cb105-103"><a href="writing-group-policy-extensions.html#cb105-103" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> e.args[<span class="dv">0</span>] <span class="op">==</span> NT_STATUS_ACCESS_DENIED:</span>
<span id="cb105-104"><a href="writing-group-policy-extensions.html#cb105-104" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> CommandError(<span class="st">&quot;The authenticated user does &quot;</span></span>
<span id="cb105-105"><a href="writing-group-policy-extensions.html#cb105-105" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;not have sufficient privileges&quot;</span>)</span>
<span id="cb105-106"><a href="writing-group-policy-extensions.html#cb105-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span></span></code></pre></div>
</div>
<div id="implementing-a-list-subcommand" class="section level5 hasAnchor" number="19.1.2.1.2">
<h5><span class="header-section-number">19.1.2.1.2</span> Implementing a List Subcommand<a href="writing-group-policy-extensions.html#implementing-a-list-subcommand" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To write a command that lists the policies for a Group Policy Object (GPO), you would need to create a class that inherits from the <code>Command</code> class provided by the <code>samba.netcmd</code> module, and define a <code>run</code> method that takes a series of arguments and options, and contains the code that will be executed when the command is run.</p>
<p>The run method should begin by connecting to a Domain Controller (DC) using the <code>smb_connection</code> function defined in <code>python/samba/netcmd/gpo.py</code>. It can then retrieve the data from the GPO’s Registry.pol file using the loadfile method of the connection object returned by the <code>smb_connection</code> function.</p>
<p>Next, the method can parse the data in the <code>Registry.pol</code> file using the <code>ndr_unpack</code> function from the <code>samba.ndr</code> module, which will return a file object representing the data in the file. The method can then iterate over the keys and values in the file object, printing out the names and data for each key.</p>
<p>The class should also define a synopsis attribute, which provides a brief summary of the command.</p>
<p>Here is an example of what it might look:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="writing-group-policy-extensions.html#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> cmd_list_script(Command):</span>
<span id="cb106-2"><a href="writing-group-policy-extensions.html#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;List Script Group Policy from the sysvol</span></span>
<span id="cb106-3"><a href="writing-group-policy-extensions.html#cb106-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-4"><a href="writing-group-policy-extensions.html#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="co">This command lists the script policies currently set on the sysvol.</span></span>
<span id="cb106-5"><a href="writing-group-policy-extensions.html#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="writing-group-policy-extensions.html#cb106-6" aria-hidden="true" tabindex="-1"></a><span class="co">Example:</span></span>
<span id="cb106-7"><a href="writing-group-policy-extensions.html#cb106-7" aria-hidden="true" tabindex="-1"></a><span class="co">samba-tool gpo manage scripts list </span><span class="ch">\</span></span>
<span id="cb106-8"><a href="writing-group-policy-extensions.html#cb106-8" aria-hidden="true" tabindex="-1"></a><span class="co"> {31B2F340-016D-11D2-945F-00C04FB984F9}</span></span>
<span id="cb106-9"><a href="writing-group-policy-extensions.html#cb106-9" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb106-10"><a href="writing-group-policy-extensions.html#cb106-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-11"><a href="writing-group-policy-extensions.html#cb106-11" aria-hidden="true" tabindex="-1"></a>    synopsis <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%prog</span><span class="st"> &lt;gpo&gt; [options]&quot;</span></span>
<span id="cb106-12"><a href="writing-group-policy-extensions.html#cb106-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-13"><a href="writing-group-policy-extensions.html#cb106-13" aria-hidden="true" tabindex="-1"></a>    takes_optiongroups <span class="op">=</span> {</span>
<span id="cb106-14"><a href="writing-group-policy-extensions.html#cb106-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sambaopts&quot;</span>: options.SambaOptions,</span>
<span id="cb106-15"><a href="writing-group-policy-extensions.html#cb106-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;versionopts&quot;</span>: options.VersionOptions,</span>
<span id="cb106-16"><a href="writing-group-policy-extensions.html#cb106-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;credopts&quot;</span>: options.CredentialsOptions,</span>
<span id="cb106-17"><a href="writing-group-policy-extensions.html#cb106-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb106-18"><a href="writing-group-policy-extensions.html#cb106-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-19"><a href="writing-group-policy-extensions.html#cb106-19" aria-hidden="true" tabindex="-1"></a>    takes_options <span class="op">=</span> [</span>
<span id="cb106-20"><a href="writing-group-policy-extensions.html#cb106-20" aria-hidden="true" tabindex="-1"></a>        Option(<span class="st">&quot;-H&quot;</span>, <span class="st">&quot;--URL&quot;</span>,</span>
<span id="cb106-21"><a href="writing-group-policy-extensions.html#cb106-21" aria-hidden="true" tabindex="-1"></a>               <span class="bu">help</span><span class="op">=</span><span class="st">&quot;LDB URL for database or target server&quot;</span>,</span>
<span id="cb106-22"><a href="writing-group-policy-extensions.html#cb106-22" aria-hidden="true" tabindex="-1"></a>           <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, metavar<span class="op">=</span><span class="st">&quot;URL&quot;</span>, dest<span class="op">=</span><span class="st">&quot;H&quot;</span>),</span>
<span id="cb106-23"><a href="writing-group-policy-extensions.html#cb106-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb106-24"><a href="writing-group-policy-extensions.html#cb106-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-25"><a href="writing-group-policy-extensions.html#cb106-25" aria-hidden="true" tabindex="-1"></a>    takes_args <span class="op">=</span> [<span class="st">&quot;gpo&quot;</span>]</span>
<span id="cb106-26"><a href="writing-group-policy-extensions.html#cb106-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-27"><a href="writing-group-policy-extensions.html#cb106-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>, gpo, H<span class="op">=</span><span class="va">None</span>, sambaopts<span class="op">=</span><span class="va">None</span>, credopts<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb106-28"><a href="writing-group-policy-extensions.html#cb106-28" aria-hidden="true" tabindex="-1"></a>            versionopts<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb106-29"><a href="writing-group-policy-extensions.html#cb106-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lp <span class="op">=</span> sambaopts.get_loadparm()</span>
<span id="cb106-30"><a href="writing-group-policy-extensions.html#cb106-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.creds <span class="op">=</span> credopts.get_credentials(<span class="va">self</span>.lp,</span>
<span id="cb106-31"><a href="writing-group-policy-extensions.html#cb106-31" aria-hidden="true" tabindex="-1"></a>                                          fallback_machine<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb106-32"><a href="writing-group-policy-extensions.html#cb106-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-33"><a href="writing-group-policy-extensions.html#cb106-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to know writable DC to setup SMB connection</span></span>
<span id="cb106-34"><a href="writing-group-policy-extensions.html#cb106-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> H <span class="kw">and</span> H.startswith(<span class="st">&#39;ldap://&#39;</span>):</span>
<span id="cb106-35"><a href="writing-group-policy-extensions.html#cb106-35" aria-hidden="true" tabindex="-1"></a>            dc_hostname <span class="op">=</span> H[<span class="dv">7</span>:]</span>
<span id="cb106-36"><a href="writing-group-policy-extensions.html#cb106-36" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.url <span class="op">=</span> H</span>
<span id="cb106-37"><a href="writing-group-policy-extensions.html#cb106-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb106-38"><a href="writing-group-policy-extensions.html#cb106-38" aria-hidden="true" tabindex="-1"></a>            dc_hostname <span class="op">=</span> netcmd_finddc(<span class="va">self</span>.lp, <span class="va">self</span>.creds)</span>
<span id="cb106-39"><a href="writing-group-policy-extensions.html#cb106-39" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.url <span class="op">=</span> dc_url(<span class="va">self</span>.lp, <span class="va">self</span>.creds, dc<span class="op">=</span>dc_hostname)</span>
<span id="cb106-40"><a href="writing-group-policy-extensions.html#cb106-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-41"><a href="writing-group-policy-extensions.html#cb106-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SMB connect to DC</span></span>
<span id="cb106-42"><a href="writing-group-policy-extensions.html#cb106-42" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> smb_connection(dc_hostname,</span>
<span id="cb106-43"><a href="writing-group-policy-extensions.html#cb106-43" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;sysvol&#39;</span>,</span>
<span id="cb106-44"><a href="writing-group-policy-extensions.html#cb106-44" aria-hidden="true" tabindex="-1"></a>                              lp<span class="op">=</span><span class="va">self</span>.lp,</span>
<span id="cb106-45"><a href="writing-group-policy-extensions.html#cb106-45" aria-hidden="true" tabindex="-1"></a>                              creds<span class="op">=</span><span class="va">self</span>.creds)</span>
<span id="cb106-46"><a href="writing-group-policy-extensions.html#cb106-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-47"><a href="writing-group-policy-extensions.html#cb106-47" aria-hidden="true" tabindex="-1"></a>        realm <span class="op">=</span> <span class="va">self</span>.lp.get(<span class="st">&#39;realm&#39;</span>)</span>
<span id="cb106-48"><a href="writing-group-policy-extensions.html#cb106-48" aria-hidden="true" tabindex="-1"></a>        pol_file <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span>.join([realm.lower(), <span class="st">&#39;Policies&#39;</span>, gpo,</span>
<span id="cb106-49"><a href="writing-group-policy-extensions.html#cb106-49" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Registry.pol&#39;</span>])</span>
<span id="cb106-50"><a href="writing-group-policy-extensions.html#cb106-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> policy_class <span class="kw">in</span> [<span class="st">&#39;MACHINE&#39;</span>, <span class="st">&#39;USER&#39;</span>]:</span>
<span id="cb106-51"><a href="writing-group-policy-extensions.html#cb106-51" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.outf.write(<span class="st">&#39;</span><span class="sc">%s</span><span class="st">:</span><span class="ch">\n</span><span class="st">&#39;</span> <span class="op">%</span> policy_class)</span>
<span id="cb106-52"><a href="writing-group-policy-extensions.html#cb106-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb106-53"><a href="writing-group-policy-extensions.html#cb106-53" aria-hidden="true" tabindex="-1"></a>                pol_data <span class="op">=</span> ndr_unpack(preg.<span class="bu">file</span>,</span>
<span id="cb106-54"><a href="writing-group-policy-extensions.html#cb106-54" aria-hidden="true" tabindex="-1"></a>                          conn.loadfile(pol_file <span class="op">%</span> policy_class))</span>
<span id="cb106-55"><a href="writing-group-policy-extensions.html#cb106-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> NTSTATUSError <span class="im">as</span> e:</span>
<span id="cb106-56"><a href="writing-group-policy-extensions.html#cb106-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> e.args[<span class="dv">0</span>] <span class="kw">in</span> [NT_STATUS_OBJECT_NAME_INVALID,</span>
<span id="cb106-57"><a href="writing-group-policy-extensions.html#cb106-57" aria-hidden="true" tabindex="-1"></a>                                 NT_STATUS_OBJECT_NAME_NOT_FOUND,</span>
<span id="cb106-58"><a href="writing-group-policy-extensions.html#cb106-58" aria-hidden="true" tabindex="-1"></a>                                 NT_STATUS_OBJECT_PATH_NOT_FOUND]:</span>
<span id="cb106-59"><a href="writing-group-policy-extensions.html#cb106-59" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># The file doesn&#39;t exist,</span></span>
<span id="cb106-60"><a href="writing-group-policy-extensions.html#cb106-60" aria-hidden="true" tabindex="-1"></a>            <span class="co"># so there is nothing to list</span></span>
<span id="cb106-61"><a href="writing-group-policy-extensions.html#cb106-61" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb106-62"><a href="writing-group-policy-extensions.html#cb106-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> e.args[<span class="dv">0</span>] <span class="op">==</span> NT_STATUS_ACCESS_DENIED:</span>
<span id="cb106-63"><a href="writing-group-policy-extensions.html#cb106-63" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> CommandError(<span class="st">&quot;The authenticated user &quot;</span></span>
<span id="cb106-64"><a href="writing-group-policy-extensions.html#cb106-64" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;does not have sufficient privileges&quot;</span>)</span>
<span id="cb106-65"><a href="writing-group-policy-extensions.html#cb106-65" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb106-66"><a href="writing-group-policy-extensions.html#cb106-66" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span></span>
<span id="cb106-67"><a href="writing-group-policy-extensions.html#cb106-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-68"><a href="writing-group-policy-extensions.html#cb106-68" aria-hidden="true" tabindex="-1"></a>            reg_key <span class="op">=</span> <span class="st">&#39;Software</span><span class="ch">\\</span><span class="st">Policies</span><span class="ch">\\</span><span class="st">Samba</span><span class="ch">\\</span><span class="st">Unix Settings&#39;</span></span>
<span id="cb106-69"><a href="writing-group-policy-extensions.html#cb106-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> e <span class="kw">in</span> pol_data.entries:</span>
<span id="cb106-70"><a href="writing-group-policy-extensions.html#cb106-70" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> e.valuename <span class="op">==</span> <span class="st">&quot;**delvals.&quot;</span>:</span>
<span id="cb106-71"><a href="writing-group-policy-extensions.html#cb106-71" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb106-72"><a href="writing-group-policy-extensions.html#cb106-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> e.keyname.startswith(reg_key) <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb106-73"><a href="writing-group-policy-extensions.html#cb106-73" aria-hidden="true" tabindex="-1"></a>                        e.keyname.endswith(<span class="st">&#39;Scripts&#39;</span>):</span>
<span id="cb106-74"><a href="writing-group-policy-extensions.html#cb106-74" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.outf.write(<span class="st">&quot;</span><span class="ch">\t</span><span class="sc">%s</span><span class="st">:</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">%</span> e.keyname)</span>
<span id="cb106-75"><a href="writing-group-policy-extensions.html#cb106-75" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.outf.write(<span class="st">&quot;</span><span class="ch">\t\t</span><span class="sc">%s</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">%</span> e.data)</span></code></pre></div>
</div>
<div id="implementing-a-remove-subcommand" class="section level5 hasAnchor" number="19.1.2.1.3">
<h5><span class="header-section-number">19.1.2.1.3</span> Implementing a Remove Subcommand<a href="writing-group-policy-extensions.html#implementing-a-remove-subcommand" class="anchor-section" aria-label="Anchor link to header"></a></h5>
<p>To write a command that removes a policy from a Group Policy Object (GPO), you would need to create a class that inherits from the <code>Command</code> class provided by the <code>samba.netcmd</code> module, and define a <code>run</code> method that takes a series of arguments and options, and contains the code that will be executed when the command is run.</p>
<p>The run method should begin by connecting to a Domain Controller (DC) using the <code>smb_connection</code> function defined in <code>python/samba/netcmd/gpo.py</code>. It can then retrieve the data from the GPO’s Registry.pol file using the loadfile method of the connection object returned by the <code>smb_connection</code> function.</p>
<p>Next, the method can parse the data in the Registry.pol file using the <code>ndr_unpack</code> function, which will return a file object representing the data in the file. It then checks whether the entry specified in the “script” variable exists in the list of entries contained in the <code>pol_data</code> object. If the entry does exist, it is removed from the list and the number of entries in the list is updated.</p>
<p>Finally, we save the modified file object back to the GPO’s <code>Registry.pol</code> file on the DC using the savefile method of the connection object.</p>
<p>The class should also define a synopsis attribute, which provides a brief summary of the command.</p>
<p>Here is an example of what it might look:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="writing-group-policy-extensions.html#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> cmd_remove_script(Command):</span>
<span id="cb107-2"><a href="writing-group-policy-extensions.html#cb107-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Removes Script Group Policy from the sysvol</span></span>
<span id="cb107-3"><a href="writing-group-policy-extensions.html#cb107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-4"><a href="writing-group-policy-extensions.html#cb107-4" aria-hidden="true" tabindex="-1"></a><span class="co">This command removes a script policy from the sysvol.</span></span>
<span id="cb107-5"><a href="writing-group-policy-extensions.html#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="writing-group-policy-extensions.html#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="co">Example:</span></span>
<span id="cb107-7"><a href="writing-group-policy-extensions.html#cb107-7" aria-hidden="true" tabindex="-1"></a><span class="co">samba-tool gpo manage scripts remove </span><span class="ch">\</span></span>
<span id="cb107-8"><a href="writing-group-policy-extensions.html#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="co"> {31B2F340-016D-11D2-945F-00C04FB984F9} MACHINE daily </span><span class="ch">\</span></span>
<span id="cb107-9"><a href="writing-group-policy-extensions.html#cb107-9" aria-hidden="true" tabindex="-1"></a><span class="co"> &#39;test_script.sh </span><span class="ch">\\</span><span class="co">-n </span><span class="ch">\\</span><span class="co">-p all&#39;</span></span>
<span id="cb107-10"><a href="writing-group-policy-extensions.html#cb107-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-11"><a href="writing-group-policy-extensions.html#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="co">policy_class is defined as either MACHINE or USER.</span></span>
<span id="cb107-12"><a href="writing-group-policy-extensions.html#cb107-12" aria-hidden="true" tabindex="-1"></a><span class="co">freq is defined as either Daily, Monthly, Weekly, or Hourly.</span></span>
<span id="cb107-13"><a href="writing-group-policy-extensions.html#cb107-13" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb107-14"><a href="writing-group-policy-extensions.html#cb107-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-15"><a href="writing-group-policy-extensions.html#cb107-15" aria-hidden="true" tabindex="-1"></a>    synopsis <span class="op">=</span> <span class="st">&quot;</span><span class="sc">%prog</span><span class="st"> &lt;gpo&gt; &lt;policy_class&gt; &lt;freq&gt; &lt;script&gt;&quot;</span></span>
<span id="cb107-16"><a href="writing-group-policy-extensions.html#cb107-16" aria-hidden="true" tabindex="-1"></a>               <span class="co">&quot;[options]&quot;</span></span>
<span id="cb107-17"><a href="writing-group-policy-extensions.html#cb107-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-18"><a href="writing-group-policy-extensions.html#cb107-18" aria-hidden="true" tabindex="-1"></a>    takes_optiongroups <span class="op">=</span> {</span>
<span id="cb107-19"><a href="writing-group-policy-extensions.html#cb107-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;sambaopts&quot;</span>: options.SambaOptions,</span>
<span id="cb107-20"><a href="writing-group-policy-extensions.html#cb107-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;versionopts&quot;</span>: options.VersionOptions,</span>
<span id="cb107-21"><a href="writing-group-policy-extensions.html#cb107-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;credopts&quot;</span>: options.CredentialsOptions,</span>
<span id="cb107-22"><a href="writing-group-policy-extensions.html#cb107-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb107-23"><a href="writing-group-policy-extensions.html#cb107-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-24"><a href="writing-group-policy-extensions.html#cb107-24" aria-hidden="true" tabindex="-1"></a>    takes_options <span class="op">=</span> [</span>
<span id="cb107-25"><a href="writing-group-policy-extensions.html#cb107-25" aria-hidden="true" tabindex="-1"></a>        Option(<span class="st">&quot;-H&quot;</span>, <span class="st">&quot;--URL&quot;</span>,</span>
<span id="cb107-26"><a href="writing-group-policy-extensions.html#cb107-26" aria-hidden="true" tabindex="-1"></a>               <span class="bu">help</span><span class="op">=</span><span class="st">&quot;LDB URL for database or target server&quot;</span>,</span>
<span id="cb107-27"><a href="writing-group-policy-extensions.html#cb107-27" aria-hidden="true" tabindex="-1"></a>           <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, metavar<span class="op">=</span><span class="st">&quot;URL&quot;</span>, dest<span class="op">=</span><span class="st">&quot;H&quot;</span>),</span>
<span id="cb107-28"><a href="writing-group-policy-extensions.html#cb107-28" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb107-29"><a href="writing-group-policy-extensions.html#cb107-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-30"><a href="writing-group-policy-extensions.html#cb107-30" aria-hidden="true" tabindex="-1"></a>    takes_args <span class="op">=</span> [<span class="st">&quot;gpo&quot;</span>, <span class="st">&quot;policy_class&quot;</span>, <span class="st">&quot;freq&quot;</span>, <span class="st">&quot;script&quot;</span>]</span>
<span id="cb107-31"><a href="writing-group-policy-extensions.html#cb107-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-32"><a href="writing-group-policy-extensions.html#cb107-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>, gpo, policy_class, freq, script, H<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb107-33"><a href="writing-group-policy-extensions.html#cb107-33" aria-hidden="true" tabindex="-1"></a>            sambaopts<span class="op">=</span><span class="va">None</span>, credopts<span class="op">=</span><span class="va">None</span>, versionopts<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb107-34"><a href="writing-group-policy-extensions.html#cb107-34" aria-hidden="true" tabindex="-1"></a>        policy_class <span class="op">=</span> policy_class.upper()</span>
<span id="cb107-35"><a href="writing-group-policy-extensions.html#cb107-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> policy_class <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;MACHINE&#39;</span>, <span class="st">&#39;USER&#39;</span>]:</span>
<span id="cb107-36"><a href="writing-group-policy-extensions.html#cb107-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> CommandError(<span class="st">&quot;&#39;</span><span class="sc">%s</span><span class="st">&#39; is not a valid policy_class.&quot;</span></span>
<span id="cb107-37"><a href="writing-group-policy-extensions.html#cb107-37" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot; Choose from MACHINE or USER&quot;</span> <span class="op">%</span> policy_class)</span>
<span id="cb107-38"><a href="writing-group-policy-extensions.html#cb107-38" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> freq.title()</span>
<span id="cb107-39"><a href="writing-group-policy-extensions.html#cb107-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> freq <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;Daily&#39;</span>, <span class="st">&#39;Monthly&#39;</span>, <span class="st">&#39;Weekly&#39;</span>, <span class="st">&#39;Hourly&#39;</span>]:</span>
<span id="cb107-40"><a href="writing-group-policy-extensions.html#cb107-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> CommandError(<span class="st">&quot;&#39;</span><span class="sc">%s</span><span class="st">&#39; is not a valid frequency. &quot;</span></span>
<span id="cb107-41"><a href="writing-group-policy-extensions.html#cb107-41" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Choose from Daily, Monthly, &quot;</span></span>
<span id="cb107-42"><a href="writing-group-policy-extensions.html#cb107-42" aria-hidden="true" tabindex="-1"></a>                   <span class="st">&quot;Weekly, or Hourly&quot;</span> <span class="op">%</span> freq)</span>
<span id="cb107-43"><a href="writing-group-policy-extensions.html#cb107-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-44"><a href="writing-group-policy-extensions.html#cb107-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lp <span class="op">=</span> sambaopts.get_loadparm()</span>
<span id="cb107-45"><a href="writing-group-policy-extensions.html#cb107-45" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.creds <span class="op">=</span> credopts.get_credentials(<span class="va">self</span>.lp,</span>
<span id="cb107-46"><a href="writing-group-policy-extensions.html#cb107-46" aria-hidden="true" tabindex="-1"></a>                                          fallback_machine<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb107-47"><a href="writing-group-policy-extensions.html#cb107-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-48"><a href="writing-group-policy-extensions.html#cb107-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We need to know writable DC to setup SMB connection</span></span>
<span id="cb107-49"><a href="writing-group-policy-extensions.html#cb107-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> H <span class="kw">and</span> H.startswith(<span class="st">&#39;ldap://&#39;</span>):</span>
<span id="cb107-50"><a href="writing-group-policy-extensions.html#cb107-50" aria-hidden="true" tabindex="-1"></a>            dc_hostname <span class="op">=</span> H[<span class="dv">7</span>:]</span>
<span id="cb107-51"><a href="writing-group-policy-extensions.html#cb107-51" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.url <span class="op">=</span> H</span>
<span id="cb107-52"><a href="writing-group-policy-extensions.html#cb107-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb107-53"><a href="writing-group-policy-extensions.html#cb107-53" aria-hidden="true" tabindex="-1"></a>            dc_hostname <span class="op">=</span> netcmd_finddc(<span class="va">self</span>.lp, <span class="va">self</span>.creds)</span>
<span id="cb107-54"><a href="writing-group-policy-extensions.html#cb107-54" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.url <span class="op">=</span> dc_url(<span class="va">self</span>.lp, <span class="va">self</span>.creds, dc<span class="op">=</span>dc_hostname)</span>
<span id="cb107-55"><a href="writing-group-policy-extensions.html#cb107-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-56"><a href="writing-group-policy-extensions.html#cb107-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># SMB connect to DC</span></span>
<span id="cb107-57"><a href="writing-group-policy-extensions.html#cb107-57" aria-hidden="true" tabindex="-1"></a>        conn <span class="op">=</span> smb_connection(dc_hostname,</span>
<span id="cb107-58"><a href="writing-group-policy-extensions.html#cb107-58" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;sysvol&#39;</span>,</span>
<span id="cb107-59"><a href="writing-group-policy-extensions.html#cb107-59" aria-hidden="true" tabindex="-1"></a>                              lp<span class="op">=</span><span class="va">self</span>.lp,</span>
<span id="cb107-60"><a href="writing-group-policy-extensions.html#cb107-60" aria-hidden="true" tabindex="-1"></a>                              creds<span class="op">=</span><span class="va">self</span>.creds)</span>
<span id="cb107-61"><a href="writing-group-policy-extensions.html#cb107-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-62"><a href="writing-group-policy-extensions.html#cb107-62" aria-hidden="true" tabindex="-1"></a>        realm <span class="op">=</span> <span class="va">self</span>.lp.get(<span class="st">&#39;realm&#39;</span>)</span>
<span id="cb107-63"><a href="writing-group-policy-extensions.html#cb107-63" aria-hidden="true" tabindex="-1"></a>        pol_file <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span>.join([realm.lower(), <span class="st">&#39;Policies&#39;</span>, gpo,</span>
<span id="cb107-64"><a href="writing-group-policy-extensions.html#cb107-64" aria-hidden="true" tabindex="-1"></a>                              <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Registry.pol&#39;</span> <span class="op">%</span> policy_class])</span>
<span id="cb107-65"><a href="writing-group-policy-extensions.html#cb107-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb107-66"><a href="writing-group-policy-extensions.html#cb107-66" aria-hidden="true" tabindex="-1"></a>            pol_data <span class="op">=</span> ndr_unpack(preg.<span class="bu">file</span>,</span>
<span id="cb107-67"><a href="writing-group-policy-extensions.html#cb107-67" aria-hidden="true" tabindex="-1"></a>                                  conn.loadfile(pol_file))</span>
<span id="cb107-68"><a href="writing-group-policy-extensions.html#cb107-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> NTSTATUSError <span class="im">as</span> e:</span>
<span id="cb107-69"><a href="writing-group-policy-extensions.html#cb107-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> e.args[<span class="dv">0</span>] <span class="kw">in</span> [NT_STATUS_OBJECT_NAME_INVALID,</span>
<span id="cb107-70"><a href="writing-group-policy-extensions.html#cb107-70" aria-hidden="true" tabindex="-1"></a>                                 NT_STATUS_OBJECT_NAME_NOT_FOUND,</span>
<span id="cb107-71"><a href="writing-group-policy-extensions.html#cb107-71" aria-hidden="true" tabindex="-1"></a>                                 NT_STATUS_OBJECT_PATH_NOT_FOUND]:</span>
<span id="cb107-72"><a href="writing-group-policy-extensions.html#cb107-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> CommandError(<span class="st">&quot;Cannot remove script &#39;</span><span class="sc">%s</span><span class="st">&#39; &quot;</span></span>
<span id="cb107-73"><a href="writing-group-policy-extensions.html#cb107-73" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;because it does not exist&quot;</span> <span class="op">%</span> script)</span>
<span id="cb107-74"><a href="writing-group-policy-extensions.html#cb107-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> e.args[<span class="dv">0</span>] <span class="op">==</span> NT_STATUS_ACCESS_DENIED:</span>
<span id="cb107-75"><a href="writing-group-policy-extensions.html#cb107-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span> CommandError(<span class="st">&quot;The authenticated user does &quot;</span></span>
<span id="cb107-76"><a href="writing-group-policy-extensions.html#cb107-76" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;not have sufficient privileges&quot;</span>)</span>
<span id="cb107-77"><a href="writing-group-policy-extensions.html#cb107-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb107-78"><a href="writing-group-policy-extensions.html#cb107-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span></span>
<span id="cb107-79"><a href="writing-group-policy-extensions.html#cb107-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-80"><a href="writing-group-policy-extensions.html#cb107-80" aria-hidden="true" tabindex="-1"></a>        script <span class="op">=</span> script.strip()</span>
<span id="cb107-81"><a href="writing-group-policy-extensions.html#cb107-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> script <span class="kw">in</span> ([e.data.strip() <span class="cf">for</span> e <span class="kw">in</span> pol_data.entries] <span class="op">\</span></span>
<span id="cb107-82"><a href="writing-group-policy-extensions.html#cb107-82" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">if</span> pol_data <span class="cf">else</span> []):</span>
<span id="cb107-83"><a href="writing-group-policy-extensions.html#cb107-83" aria-hidden="true" tabindex="-1"></a>            entries <span class="op">=</span> [e <span class="cf">for</span> e <span class="kw">in</span> pol_data.entries <span class="op">\</span></span>
<span id="cb107-84"><a href="writing-group-policy-extensions.html#cb107-84" aria-hidden="true" tabindex="-1"></a>                       <span class="cf">if</span> e.data.strip() <span class="op">!=</span> script]</span>
<span id="cb107-85"><a href="writing-group-policy-extensions.html#cb107-85" aria-hidden="true" tabindex="-1"></a>            pol_data.num_entries <span class="op">=</span> <span class="bu">len</span>(entries)</span>
<span id="cb107-86"><a href="writing-group-policy-extensions.html#cb107-86" aria-hidden="true" tabindex="-1"></a>            pol_data.entries <span class="op">=</span> entries</span>
<span id="cb107-87"><a href="writing-group-policy-extensions.html#cb107-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-88"><a href="writing-group-policy-extensions.html#cb107-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb107-89"><a href="writing-group-policy-extensions.html#cb107-89" aria-hidden="true" tabindex="-1"></a>                conn.savefile(pol_file, ndr_pack(pol_data))</span>
<span id="cb107-90"><a href="writing-group-policy-extensions.html#cb107-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> NTSTATUSError <span class="im">as</span> e:</span>
<span id="cb107-91"><a href="writing-group-policy-extensions.html#cb107-91" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> e.args[<span class="dv">0</span>] <span class="op">==</span> NT_STATUS_ACCESS_DENIED:</span>
<span id="cb107-92"><a href="writing-group-policy-extensions.html#cb107-92" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> CommandError(<span class="st">&quot;The authenticated user &quot;</span></span>
<span id="cb107-93"><a href="writing-group-policy-extensions.html#cb107-93" aria-hidden="true" tabindex="-1"></a>                                       <span class="st">&quot;does not have sufficient&quot;</span></span>
<span id="cb107-94"><a href="writing-group-policy-extensions.html#cb107-94" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot; privileges&quot;</span>)</span>
<span id="cb107-95"><a href="writing-group-policy-extensions.html#cb107-95" aria-hidden="true" tabindex="-1"></a>                <span class="cf">raise</span></span>
<span id="cb107-96"><a href="writing-group-policy-extensions.html#cb107-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb107-97"><a href="writing-group-policy-extensions.html#cb107-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> CommandError(<span class="st">&quot;Cannot remove &#39;</span><span class="sc">%s</span><span class="st">&#39; because it&quot;</span></span>
<span id="cb107-98"><a href="writing-group-policy-extensions.html#cb107-98" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot; does not exist&quot;</span> <span class="op">%</span> script)</span></code></pre></div>
</div>
</div>
</div>
</div>
<div id="cse" class="section level2 hasAnchor" number="19.2">
<h2><span class="header-section-number">19.2</span> Creating the Client Side Extension<a href="writing-group-policy-extensions.html#cse" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following script defines a Group Policy Client Side Extension (CSE) in Python, which will be called by Samba’s Winbind to deploy our newly created policy. A CSE is a program that runs on a client machine and processes Group Policy Objects (GPOs) that are applied to the machine. The CSE processes the GPOs by applying the policies they contain to the client machine.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="writing-group-policy-extensions.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python3</span></span>
<span id="cb108-2"><a href="writing-group-policy-extensions.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, re</span>
<span id="cb108-3"><a href="writing-group-policy-extensions.html#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> samba.gpclass <span class="im">import</span> gp_pol_ext, gp_file_applier,</span>
<span id="cb108-4"><a href="writing-group-policy-extensions.html#cb108-4" aria-hidden="true" tabindex="-1"></a>    register_gp_extension, unregister_gp_extension,</span>
<span id="cb108-5"><a href="writing-group-policy-extensions.html#cb108-5" aria-hidden="true" tabindex="-1"></a>    list_gp_extensions</span>
<span id="cb108-6"><a href="writing-group-policy-extensions.html#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tempfile <span class="im">import</span> NamedTemporaryFile</span>
<span id="cb108-7"><a href="writing-group-policy-extensions.html#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> samba.gp.util.logging <span class="im">import</span> log</span>
<span id="cb108-8"><a href="writing-group-policy-extensions.html#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> samba <span class="im">import</span> getopt <span class="im">as</span> options</span>
<span id="cb108-9"><a href="writing-group-policy-extensions.html#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> optparse</span>
<span id="cb108-10"><a href="writing-group-policy-extensions.html#cb108-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-11"><a href="writing-group-policy-extensions.html#cb108-11" aria-hidden="true" tabindex="-1"></a>intro <span class="op">=</span> <span class="st">&#39;&#39;&#39;</span></span>
<span id="cb108-12"><a href="writing-group-policy-extensions.html#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="st">### autogenerated by samba</span></span>
<span id="cb108-13"><a href="writing-group-policy-extensions.html#cb108-13" aria-hidden="true" tabindex="-1"></a><span class="st">#</span></span>
<span id="cb108-14"><a href="writing-group-policy-extensions.html#cb108-14" aria-hidden="true" tabindex="-1"></a><span class="st"># This file is generated by the gp_scripts_ext Group Policy</span></span>
<span id="cb108-15"><a href="writing-group-policy-extensions.html#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="st"># Client Side Extension. To modify the contents of this file,</span></span>
<span id="cb108-16"><a href="writing-group-policy-extensions.html#cb108-16" aria-hidden="true" tabindex="-1"></a><span class="st"># modify the appropriate Group Policy objects which apply</span></span>
<span id="cb108-17"><a href="writing-group-policy-extensions.html#cb108-17" aria-hidden="true" tabindex="-1"></a><span class="st"># to this machine. DO NOT MODIFY THIS FILE DIRECTLY.</span></span>
<span id="cb108-18"><a href="writing-group-policy-extensions.html#cb108-18" aria-hidden="true" tabindex="-1"></a><span class="st">#</span></span>
<span id="cb108-19"><a href="writing-group-policy-extensions.html#cb108-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-20"><a href="writing-group-policy-extensions.html#cb108-20" aria-hidden="true" tabindex="-1"></a><span class="st">&#39;&#39;&#39;</span></span>
<span id="cb108-21"><a href="writing-group-policy-extensions.html#cb108-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-22"><a href="writing-group-policy-extensions.html#cb108-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> gp_scripts_ext(gp_pol_ext, gp_file_applier):</span>
<span id="cb108-23"><a href="writing-group-policy-extensions.html#cb108-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb108-24"><a href="writing-group-policy-extensions.html#cb108-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;Unix Settings/Scripts&#39;</span></span>
<span id="cb108-25"><a href="writing-group-policy-extensions.html#cb108-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-26"><a href="writing-group-policy-extensions.html#cb108-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_group_policy(<span class="va">self</span>, deleted_gpo_list,</span>
<span id="cb108-27"><a href="writing-group-policy-extensions.html#cb108-27" aria-hidden="true" tabindex="-1"></a>                             changed_gpo_list):</span>
<span id="cb108-28"><a href="writing-group-policy-extensions.html#cb108-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-29"><a href="writing-group-policy-extensions.html#cb108-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Iterate over GPO guids and their previous settings,</span></span>
<span id="cb108-30"><a href="writing-group-policy-extensions.html#cb108-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># reverting changes made by this GPO.</span></span>
<span id="cb108-31"><a href="writing-group-policy-extensions.html#cb108-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> guid, settings <span class="kw">in</span> deleted_gpo_list:</span>
<span id="cb108-32"><a href="writing-group-policy-extensions.html#cb108-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-33"><a href="writing-group-policy-extensions.html#cb108-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use the unapply() function from the base class</span></span>
<span id="cb108-34"><a href="writing-group-policy-extensions.html#cb108-34" aria-hidden="true" tabindex="-1"></a>            <span class="co"># gp_file_applier to remove the files.</span></span>
<span id="cb108-35"><a href="writing-group-policy-extensions.html#cb108-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">str</span>(<span class="va">self</span>) <span class="kw">in</span> settings:</span>
<span id="cb108-36"><a href="writing-group-policy-extensions.html#cb108-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attribute, script <span class="kw">in</span> <span class="op">\</span></span>
<span id="cb108-37"><a href="writing-group-policy-extensions.html#cb108-37" aria-hidden="true" tabindex="-1"></a>                        settings[<span class="bu">str</span>(<span class="va">self</span>)].items():</span>
<span id="cb108-38"><a href="writing-group-policy-extensions.html#cb108-38" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Delete the applied policy</span></span>
<span id="cb108-39"><a href="writing-group-policy-extensions.html#cb108-39" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.unapply(guid, attribute, script)</span>
<span id="cb108-40"><a href="writing-group-policy-extensions.html#cb108-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-41"><a href="writing-group-policy-extensions.html#cb108-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Iterate over GPO objects, applying new policies found</span></span>
<span id="cb108-42"><a href="writing-group-policy-extensions.html#cb108-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># in the SYSVOL</span></span>
<span id="cb108-43"><a href="writing-group-policy-extensions.html#cb108-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> gpo <span class="kw">in</span> changed_gpo_list:</span>
<span id="cb108-44"><a href="writing-group-policy-extensions.html#cb108-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> gpo.file_sys_path:</span>
<span id="cb108-45"><a href="writing-group-policy-extensions.html#cb108-45" aria-hidden="true" tabindex="-1"></a>                reg_key <span class="op">=</span> <span class="st">&#39;Software</span><span class="ch">\\</span><span class="st">Policies</span><span class="ch">\\</span><span class="st">&#39;</span> <span class="op">+</span> <span class="op">\</span></span>
<span id="cb108-46"><a href="writing-group-policy-extensions.html#cb108-46" aria-hidden="true" tabindex="-1"></a>                          <span class="st">&#39;Samba</span><span class="ch">\\</span><span class="st">Unix Settings&#39;</span></span>
<span id="cb108-47"><a href="writing-group-policy-extensions.html#cb108-47" aria-hidden="true" tabindex="-1"></a>                sections <span class="op">=</span> { <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Daily Scripts&#39;</span> <span class="op">%</span> reg_key :</span>
<span id="cb108-48"><a href="writing-group-policy-extensions.html#cb108-48" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;/etc/cron.daily&#39;</span>,</span>
<span id="cb108-49"><a href="writing-group-policy-extensions.html#cb108-49" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Monthly Scripts&#39;</span> <span class="op">%</span> reg_key :</span>
<span id="cb108-50"><a href="writing-group-policy-extensions.html#cb108-50" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;/etc/cron.monthly&#39;</span>,</span>
<span id="cb108-51"><a href="writing-group-policy-extensions.html#cb108-51" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Weekly Scripts&#39;</span> <span class="op">%</span> reg_key :</span>
<span id="cb108-52"><a href="writing-group-policy-extensions.html#cb108-52" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;/etc/cron.weekly&#39;</span>,</span>
<span id="cb108-53"><a href="writing-group-policy-extensions.html#cb108-53" aria-hidden="true" tabindex="-1"></a>                             <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\\</span><span class="st">Hourly Scripts&#39;</span> <span class="op">%</span> reg_key :</span>
<span id="cb108-54"><a href="writing-group-policy-extensions.html#cb108-54" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;/etc/cron.hourly&#39;</span></span>
<span id="cb108-55"><a href="writing-group-policy-extensions.html#cb108-55" aria-hidden="true" tabindex="-1"></a>                           }</span>
<span id="cb108-56"><a href="writing-group-policy-extensions.html#cb108-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-57"><a href="writing-group-policy-extensions.html#cb108-57" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Load the contents of the Registry.pol</span></span>
<span id="cb108-58"><a href="writing-group-policy-extensions.html#cb108-58" aria-hidden="true" tabindex="-1"></a>                <span class="co"># from the SYSVOL</span></span>
<span id="cb108-59"><a href="writing-group-policy-extensions.html#cb108-59" aria-hidden="true" tabindex="-1"></a>                pol_file <span class="op">=</span> <span class="st">&#39;MACHINE/Registry.pol&#39;</span></span>
<span id="cb108-60"><a href="writing-group-policy-extensions.html#cb108-60" aria-hidden="true" tabindex="-1"></a>                path <span class="op">=</span> os.path.join(gpo.file_sys_path, pol_file)</span>
<span id="cb108-61"><a href="writing-group-policy-extensions.html#cb108-61" aria-hidden="true" tabindex="-1"></a>                pol_conf <span class="op">=</span> <span class="va">self</span>.parse(path)</span>
<span id="cb108-62"><a href="writing-group-policy-extensions.html#cb108-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> pol_conf:</span>
<span id="cb108-63"><a href="writing-group-policy-extensions.html#cb108-63" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb108-64"><a href="writing-group-policy-extensions.html#cb108-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-65"><a href="writing-group-policy-extensions.html#cb108-65" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Gather the list of policies to apply</span></span>
<span id="cb108-66"><a href="writing-group-policy-extensions.html#cb108-66" aria-hidden="true" tabindex="-1"></a>                policies <span class="op">=</span> {}</span>
<span id="cb108-67"><a href="writing-group-policy-extensions.html#cb108-67" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> e <span class="kw">in</span> pol_conf.entries:</span>
<span id="cb108-68"><a href="writing-group-policy-extensions.html#cb108-68" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> e.keyname <span class="kw">in</span> sections.keys() <span class="kw">and</span> <span class="op">\</span></span>
<span id="cb108-69"><a href="writing-group-policy-extensions.html#cb108-69" aria-hidden="true" tabindex="-1"></a>                            e.data.strip():</span>
<span id="cb108-70"><a href="writing-group-policy-extensions.html#cb108-70" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> e.keyname <span class="kw">not</span> <span class="kw">in</span> policies:</span>
<span id="cb108-71"><a href="writing-group-policy-extensions.html#cb108-71" aria-hidden="true" tabindex="-1"></a>                            policies[e.keyname] <span class="op">=</span> []</span>
<span id="cb108-72"><a href="writing-group-policy-extensions.html#cb108-72" aria-hidden="true" tabindex="-1"></a>                        policies[e.keyname].append(e.data)</span>
<span id="cb108-73"><a href="writing-group-policy-extensions.html#cb108-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-74"><a href="writing-group-policy-extensions.html#cb108-74" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Specify the applier function, which will be</span></span>
<span id="cb108-75"><a href="writing-group-policy-extensions.html#cb108-75" aria-hidden="true" tabindex="-1"></a>                <span class="co"># used to apply the policy.</span></span>
<span id="cb108-76"><a href="writing-group-policy-extensions.html#cb108-76" aria-hidden="true" tabindex="-1"></a>                <span class="kw">def</span> applier_func(keyname, entries):</span>
<span id="cb108-77"><a href="writing-group-policy-extensions.html#cb108-77" aria-hidden="true" tabindex="-1"></a>                    ret <span class="op">=</span> []</span>
<span id="cb108-78"><a href="writing-group-policy-extensions.html#cb108-78" aria-hidden="true" tabindex="-1"></a>                    cron_dir <span class="op">=</span> sections[e.keyname]</span>
<span id="cb108-79"><a href="writing-group-policy-extensions.html#cb108-79" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> data <span class="kw">in</span> entries:</span>
<span id="cb108-80"><a href="writing-group-policy-extensions.html#cb108-80" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">with</span> NamedTemporaryFile(prefix<span class="op">=</span><span class="st">&#39;gp_&#39;</span>,</span>
<span id="cb108-81"><a href="writing-group-policy-extensions.html#cb108-81" aria-hidden="true" tabindex="-1"></a>                                                mode<span class="op">=</span><span class="st">&quot;w+&quot;</span>,</span>
<span id="cb108-82"><a href="writing-group-policy-extensions.html#cb108-82" aria-hidden="true" tabindex="-1"></a>                                                delete<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb108-83"><a href="writing-group-policy-extensions.html#cb108-83" aria-hidden="true" tabindex="-1"></a>                                                <span class="bu">dir</span><span class="op">=</span>cron_dir) <span class="im">as</span> f:</span>
<span id="cb108-84"><a href="writing-group-policy-extensions.html#cb108-84" aria-hidden="true" tabindex="-1"></a>                            contents <span class="op">=</span> <span class="st">&#39;#!/bin/sh</span><span class="ch">\n</span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> intro</span>
<span id="cb108-85"><a href="writing-group-policy-extensions.html#cb108-85" aria-hidden="true" tabindex="-1"></a>                            contents <span class="op">+=</span> <span class="st">&#39;</span><span class="sc">%s</span><span class="ch">\n</span><span class="st">&#39;</span> <span class="op">%</span> data</span>
<span id="cb108-86"><a href="writing-group-policy-extensions.html#cb108-86" aria-hidden="true" tabindex="-1"></a>                            f.write(contents)</span>
<span id="cb108-87"><a href="writing-group-policy-extensions.html#cb108-87" aria-hidden="true" tabindex="-1"></a>                            os.chmod(f.name, <span class="bn">0o700</span>)</span>
<span id="cb108-88"><a href="writing-group-policy-extensions.html#cb108-88" aria-hidden="true" tabindex="-1"></a>                            ret.append(f.name)</span>
<span id="cb108-89"><a href="writing-group-policy-extensions.html#cb108-89" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> ret</span>
<span id="cb108-90"><a href="writing-group-policy-extensions.html#cb108-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-91"><a href="writing-group-policy-extensions.html#cb108-91" aria-hidden="true" tabindex="-1"></a>                <span class="co"># For each policy in the Registry.pol,</span></span>
<span id="cb108-92"><a href="writing-group-policy-extensions.html#cb108-92" aria-hidden="true" tabindex="-1"></a>                <span class="co"># apply the settings</span></span>
<span id="cb108-93"><a href="writing-group-policy-extensions.html#cb108-93" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> keyname, entries <span class="kw">in</span> policies.items():</span>
<span id="cb108-94"><a href="writing-group-policy-extensions.html#cb108-94" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Each GPO applies only one set of each type</span></span>
<span id="cb108-95"><a href="writing-group-policy-extensions.html#cb108-95" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># of script, so so the attribute matches the</span></span>
<span id="cb108-96"><a href="writing-group-policy-extensions.html#cb108-96" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># keyname.</span></span>
<span id="cb108-97"><a href="writing-group-policy-extensions.html#cb108-97" aria-hidden="true" tabindex="-1"></a>                    attribute <span class="op">=</span> keyname</span>
<span id="cb108-98"><a href="writing-group-policy-extensions.html#cb108-98" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># The value hash is generated from the script</span></span>
<span id="cb108-99"><a href="writing-group-policy-extensions.html#cb108-99" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># entries, ensuring any changes to this GPO</span></span>
<span id="cb108-100"><a href="writing-group-policy-extensions.html#cb108-100" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># will cause the scripts to be rewritten.</span></span>
<span id="cb108-101"><a href="writing-group-policy-extensions.html#cb108-101" aria-hidden="true" tabindex="-1"></a>                    value_hash <span class="op">=</span> <span class="va">self</span>.generate_value_hash(<span class="op">*</span>entries)</span>
<span id="cb108-102"><a href="writing-group-policy-extensions.html#cb108-102" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.<span class="bu">apply</span>(gpo.name, attribute, value_hash,</span>
<span id="cb108-103"><a href="writing-group-policy-extensions.html#cb108-103" aria-hidden="true" tabindex="-1"></a>                               applier_func, keyname, entries)</span>
<span id="cb108-104"><a href="writing-group-policy-extensions.html#cb108-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-105"><a href="writing-group-policy-extensions.html#cb108-105" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Cleanup any old scripts that are no longer</span></span>
<span id="cb108-106"><a href="writing-group-policy-extensions.html#cb108-106" aria-hidden="true" tabindex="-1"></a>                <span class="co"># part of the policy</span></span>
<span id="cb108-107"><a href="writing-group-policy-extensions.html#cb108-107" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.clean(gpo.name, keep<span class="op">=</span>policies.keys())</span>
<span id="cb108-108"><a href="writing-group-policy-extensions.html#cb108-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-109"><a href="writing-group-policy-extensions.html#cb108-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> rsop(<span class="va">self</span>, gpo):</span>
<span id="cb108-110"><a href="writing-group-policy-extensions.html#cb108-110" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> {}</span>
<span id="cb108-111"><a href="writing-group-policy-extensions.html#cb108-111" aria-hidden="true" tabindex="-1"></a>        pol_file <span class="op">=</span> <span class="st">&#39;MACHINE/Registry.pol&#39;</span></span>
<span id="cb108-112"><a href="writing-group-policy-extensions.html#cb108-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gpo.file_sys_path:</span>
<span id="cb108-113"><a href="writing-group-policy-extensions.html#cb108-113" aria-hidden="true" tabindex="-1"></a>            path <span class="op">=</span> os.path.join(gpo.file_sys_path, pol_file)</span>
<span id="cb108-114"><a href="writing-group-policy-extensions.html#cb108-114" aria-hidden="true" tabindex="-1"></a>            pol_conf <span class="op">=</span> <span class="va">self</span>.parse(path)</span>
<span id="cb108-115"><a href="writing-group-policy-extensions.html#cb108-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> pol_conf:</span>
<span id="cb108-116"><a href="writing-group-policy-extensions.html#cb108-116" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> output</span>
<span id="cb108-117"><a href="writing-group-policy-extensions.html#cb108-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> e <span class="kw">in</span> pol_conf.entries:</span>
<span id="cb108-118"><a href="writing-group-policy-extensions.html#cb108-118" aria-hidden="true" tabindex="-1"></a>                key <span class="op">=</span> e.keyname.split(<span class="st">&#39;</span><span class="ch">\\</span><span class="st">&#39;</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb108-119"><a href="writing-group-policy-extensions.html#cb108-119" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> key.endswith(<span class="st">&#39;Scripts&#39;</span>) <span class="kw">and</span> e.data.strip():</span>
<span id="cb108-120"><a href="writing-group-policy-extensions.html#cb108-120" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> output.keys():</span>
<span id="cb108-121"><a href="writing-group-policy-extensions.html#cb108-121" aria-hidden="true" tabindex="-1"></a>                        output[key] <span class="op">=</span> []</span>
<span id="cb108-122"><a href="writing-group-policy-extensions.html#cb108-122" aria-hidden="true" tabindex="-1"></a>                    output[key].append(e.data)</span>
<span id="cb108-123"><a href="writing-group-policy-extensions.html#cb108-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb108-124"><a href="writing-group-policy-extensions.html#cb108-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-125"><a href="writing-group-policy-extensions.html#cb108-125" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb108-126"><a href="writing-group-policy-extensions.html#cb108-126" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> optparse.OptionParser(<span class="st">&#39;gp_scripts_ext.py [options]&#39;</span>)</span>
<span id="cb108-127"><a href="writing-group-policy-extensions.html#cb108-127" aria-hidden="true" tabindex="-1"></a>    sambaopts <span class="op">=</span> options.SambaOptions(parser)</span>
<span id="cb108-128"><a href="writing-group-policy-extensions.html#cb108-128" aria-hidden="true" tabindex="-1"></a>    parser.add_option_group(sambaopts)</span>
<span id="cb108-129"><a href="writing-group-policy-extensions.html#cb108-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-130"><a href="writing-group-policy-extensions.html#cb108-130" aria-hidden="true" tabindex="-1"></a>    parser.add_option(<span class="st">&#39;--register&#39;</span>,</span>
<span id="cb108-131"><a href="writing-group-policy-extensions.html#cb108-131" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Register extension to Samba&#39;</span>,</span>
<span id="cb108-132"><a href="writing-group-policy-extensions.html#cb108-132" aria-hidden="true" tabindex="-1"></a>                      action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>)</span>
<span id="cb108-133"><a href="writing-group-policy-extensions.html#cb108-133" aria-hidden="true" tabindex="-1"></a>    parser.add_option(<span class="st">&#39;--unregister&#39;</span>,</span>
<span id="cb108-134"><a href="writing-group-policy-extensions.html#cb108-134" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">help</span><span class="op">=</span><span class="st">&#39;Unregister extension from Samba&#39;</span>,</span>
<span id="cb108-135"><a href="writing-group-policy-extensions.html#cb108-135" aria-hidden="true" tabindex="-1"></a>                      action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>)</span>
<span id="cb108-136"><a href="writing-group-policy-extensions.html#cb108-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-137"><a href="writing-group-policy-extensions.html#cb108-137" aria-hidden="true" tabindex="-1"></a>    (opts, args) <span class="op">=</span> parser.parse_args()</span>
<span id="cb108-138"><a href="writing-group-policy-extensions.html#cb108-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-139"><a href="writing-group-policy-extensions.html#cb108-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We&#39;re collecting the Samba loadparm simply to</span></span>
<span id="cb108-140"><a href="writing-group-policy-extensions.html#cb108-140" aria-hidden="true" tabindex="-1"></a>    <span class="co"># find our smb.conf file</span></span>
<span id="cb108-141"><a href="writing-group-policy-extensions.html#cb108-141" aria-hidden="true" tabindex="-1"></a>    lp <span class="op">=</span> sambaopts.get_loadparm()</span>
<span id="cb108-142"><a href="writing-group-policy-extensions.html#cb108-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-143"><a href="writing-group-policy-extensions.html#cb108-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is a random unique GUID, which identifies this CSE.</span></span>
<span id="cb108-144"><a href="writing-group-policy-extensions.html#cb108-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Any random GUID will do.</span></span>
<span id="cb108-145"><a href="writing-group-policy-extensions.html#cb108-145" aria-hidden="true" tabindex="-1"></a>    ext_guid <span class="op">=</span> <span class="st">&#39;{5930022C-94FF-4ED5-A403-CFB4549DB6F0}&#39;</span></span>
<span id="cb108-146"><a href="writing-group-policy-extensions.html#cb108-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> opts.register:</span>
<span id="cb108-147"><a href="writing-group-policy-extensions.html#cb108-147" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The extension path is the location of this file. This</span></span>
<span id="cb108-148"><a href="writing-group-policy-extensions.html#cb108-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># script should be executed from a permanent location.</span></span>
<span id="cb108-149"><a href="writing-group-policy-extensions.html#cb108-149" aria-hidden="true" tabindex="-1"></a>        ext_path <span class="op">=</span> os.path.realpath(<span class="va">__file__</span>)</span>
<span id="cb108-150"><a href="writing-group-policy-extensions.html#cb108-150" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The machine and user parameters tell Samba whether to</span></span>
<span id="cb108-151"><a href="writing-group-policy-extensions.html#cb108-151" aria-hidden="true" tabindex="-1"></a>        <span class="co"># apply this extension to the computer, to individual</span></span>
<span id="cb108-152"><a href="writing-group-policy-extensions.html#cb108-152" aria-hidden="true" tabindex="-1"></a>        <span class="co"># users, or to both.</span></span>
<span id="cb108-153"><a href="writing-group-policy-extensions.html#cb108-153" aria-hidden="true" tabindex="-1"></a>        register_gp_extension(ext_guid, <span class="st">&#39;gp_scripts_ext&#39;</span>,</span>
<span id="cb108-154"><a href="writing-group-policy-extensions.html#cb108-154" aria-hidden="true" tabindex="-1"></a>                              ext_path, smb_conf<span class="op">=</span>lp.configfile,</span>
<span id="cb108-155"><a href="writing-group-policy-extensions.html#cb108-155" aria-hidden="true" tabindex="-1"></a>                              machine<span class="op">=</span><span class="va">True</span>, user<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb108-156"><a href="writing-group-policy-extensions.html#cb108-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> opts.unregister:</span>
<span id="cb108-157"><a href="writing-group-policy-extensions.html#cb108-157" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Remove the extension and do not apply policy.</span></span>
<span id="cb108-158"><a href="writing-group-policy-extensions.html#cb108-158" aria-hidden="true" tabindex="-1"></a>        unregister_gp_extension(ext_guid)</span>
<span id="cb108-159"><a href="writing-group-policy-extensions.html#cb108-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-160"><a href="writing-group-policy-extensions.html#cb108-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List the currently installed Group Policy Client Side</span></span>
<span id="cb108-161"><a href="writing-group-policy-extensions.html#cb108-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extensions</span></span>
<span id="cb108-162"><a href="writing-group-policy-extensions.html#cb108-162" aria-hidden="true" tabindex="-1"></a>    exts <span class="op">=</span> list_gp_extensions(lp.configfile)</span>
<span id="cb108-163"><a href="writing-group-policy-extensions.html#cb108-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> guid, data <span class="kw">in</span> exts.items():</span>
<span id="cb108-164"><a href="writing-group-policy-extensions.html#cb108-164" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(guid)</span>
<span id="cb108-165"><a href="writing-group-policy-extensions.html#cb108-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k, v <span class="kw">in</span> data.items():</span>
<span id="cb108-166"><a href="writing-group-policy-extensions.html#cb108-166" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&#39;</span><span class="ch">\t</span><span class="sc">%s</span><span class="st">: </span><span class="sc">%s</span><span class="st">&#39;</span> <span class="op">%</span> (k, v))</span></code></pre></div>
<p>The CSE is defined by the <code>gp_scripts_ext</code> class, which is derived from the <code>gp_pol_ext</code> and <code>gp_file_applier</code> classes. The <code>gp_pol_ext</code> class provides a framework for processing GPOs, and the <code>gp_file_applier</code> class provides functions for applying GPO policies to files on the client machine.</p>
<div id="the-gp_ext-and-gp_applier-python-classes" class="section level3 hasAnchor" number="19.2.1">
<h3><span class="header-section-number">19.2.1</span> The gp_ext and gp_applier Python Classes<a href="writing-group-policy-extensions.html#the-gp_ext-and-gp_applier-python-classes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Your CSE must be a class that inherits from subclasses of <code>gp_ext</code> and <code>gp_applier</code>. The <code>gp_pol_ext</code> is a subclass of <code>gp_ext</code> that provides simplified parsing of Registry.pol files. If you choose to store your policies in ini/inf files in the SYSVOL (instead of using Administrative Templates), then you can inherit from the <code>gp_inf_ext</code> instead. The <code>gp_file_applier</code> is a subclass of <code>gp_applier</code> which provides convenience functions for applying and unapplying policies which add files to the machine.</p>
<p>If your class inherits from either <code>gp_pol_ext</code> or <code>gp_inf_ext</code>, it has a <code>parse()</code> function defined, which takes a single filename. The parse() function will parse the contents of the policy file and return it in a sensible format.</p>
<p>If for some reason you choose to store data on the SYSVOL in some other format (such as in XML, etc), you’ll need to subclass <code>gp_ext</code>, then implement a <code>read()</code> function, like this:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="writing-group-policy-extensions.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xml.etree.ElementTree</span>
<span id="cb109-2"><a href="writing-group-policy-extensions.html#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> gp_xml_ext(gp_ext):</span>
<span id="cb109-3"><a href="writing-group-policy-extensions.html#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read(<span class="va">self</span>, data_file):</span>
<span id="cb109-4"><a href="writing-group-policy-extensions.html#cb109-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> xml.etree.ElementTree.parse(data_file)</span></code></pre></div>
<p>The <code>read()</code> function is called by <code>parse()</code>, passing it a local filename tied to the systems SYSVOL cache. Then within <code>process_group_policy()</code> you can call <code>parse()</code> to fetch the parsed data from the SYSVOL.</p>
<p>The <code>gp_file_applier</code> class implements the helper functions <code>apply</code> and <code>unapply</code>. If you instead inherit from <code>gp_applier</code> directly, you’ll need to implement <code>apply</code> and <code>unapply</code> yourself. The <code>gp_applier</code> class provides various helper functions for assisting you in creating the <code>apply</code> and <code>unapply</code> functions.</p>
</div>
<div id="process-group-policy" class="section level3 hasAnchor" number="19.2.2">
<h3><span class="header-section-number">19.2.2</span> Process Group Policy<a href="writing-group-policy-extensions.html#process-group-policy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The CSE has two main functions: <code>process_group_policy</code> and <code>rsop</code>. The <code>process_group_policy</code> function is called by the Group Policy engine on the client machine to process the GPOs that apply to the machine. It takes two arguments: <code>deleted_gpo_list</code> and <code>changed_gpo_list</code>. The <code>deleted_gpo_list</code> argument is a list of GPOs that MUST be removed from the machine, and the <code>changed_gpo_list</code> argument is a list of GPOs that have been changed (or are new) and MUST be re-applied to the machine.</p>
<p>The <code>process_group_policy</code> function serves two primary purposes; it applies new policy, and it removes old policy. It first iterates over the <code>deleted_gpo_list</code>, using the unapply function from the <code>gp_file_applier</code> class to remove the files that were applied by the GPOs.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="writing-group-policy-extensions.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> guid, settings <span class="kw">in</span> deleted_gpo_list:</span>
<span id="cb110-2"><a href="writing-group-policy-extensions.html#cb110-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">str</span>(<span class="va">self</span>) <span class="kw">in</span> settings:</span>
<span id="cb110-3"><a href="writing-group-policy-extensions.html#cb110-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attribute, script <span class="kw">in</span> settings[<span class="bu">str</span>(<span class="va">self</span>)].items():</span>
<span id="cb110-4"><a href="writing-group-policy-extensions.html#cb110-4" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.unapply(guid, attribute, script)</span></code></pre></div>
<p>The <code>deleted_gpo_list</code> is a dictionary which contains the guids of Group Policy Objects, with associated settings which were previously applied. This list of applied settings is generated by the second loop (<code>changed_gpo_list</code>) while it is applying policy.</p>
<p>The <code>process_group_policy</code> function then iterates over the <code>changed_gpo_list</code>, applying the policies contained in the GPOs to the client machine. This second loop is a little more involved. When we iterate over <code>changed_gpo_list</code>, we’re actually iterating over a list of GPO objects. The attributes of the object are:</p>
<ul>
<li><code>gpo.name</code>: The GUID of the GPO.</li>
<li><code>gpo.file_sys_path</code>: A physical path to a cache of GPO on the local filesystem.</li>
</ul>
<p>There are other methods and attributes, but these are the only ones important to a CSE.</p>
<p>The primary purpose of this loop is to iterate over the GPOs, read their policy in the SYSVOL, then check the sections for the Registry Key we created in our Server Side Extension. If our policy Registry Key exists, then we read the entry and apply the policy.</p>
<p>In our example, we find the ‘Software\Policies\Samba\Unix Settings\Daily Scripts’ policy, then read the script contents from Registry.pol entry and write the script to a local file.</p>
<p>The <code>applier_func</code> function is called to apply the policies contained in the GPOs to the client machine. It takes two arguments: keyname and entries. The keyname argument is the name of the policy being applied, and the entries argument is a list of the policy entries. The function writes the policy entries to randomly generated file names in the appropriate cron directories on the client machine, and returns the names of the temporary files. The file names will be stored in the Group Policy Cache, for retrieving later for the <code>deleted_gpo_list</code>.</p>
</div>
<div id="resultant-set-of-policy" class="section level3 hasAnchor" number="19.2.3">
<h3><span class="header-section-number">19.2.3</span> Resultant Set of Policy<a href="writing-group-policy-extensions.html#resultant-set-of-policy" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>rsop</code> function in the extension is optional. It should return a dictionary containing key/value pairs of what our current policy will apply or has applied. The function is passed a list of GPO objects (similar to our <code>changed_gpo_list</code>), and we should parse the list similar to how we did in <code>process_group_policy</code>.</p>
<p>The <code>rsop</code> function generates the output for our Resultant Set of Policy. RSoP is a feature in Group Policy that allows you to determine the effective settings that are applied to a user or a computer as a result of Group Policy processing. RSoP provides a report that shows the policies that have been applied to the user or computer, as well as any conflicts or errors that may have occurred during Group Policy processing. RSoP can be used to troubleshoot Group Policy issues, to verify that the correct policies are being applied, and to determine the impact of Group Policy on a particular user or computer.</p>
<p>This function enables the <code>samba-gpupdate --rsop</code> command.</p>
</div>
<div id="registeringunregistering-a-client-side-extension" class="section level3 hasAnchor" number="19.2.4">
<h3><span class="header-section-number">19.2.4</span> Registering/Unregistering a Client Side Extension<a href="writing-group-policy-extensions.html#registeringunregistering-a-client-side-extension" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The CSE also includes a function for registering and unregistering the CSE with the Group Policy engine on the client machine. While the example code provides a detailed example of how to register an extension, the basic requirement is simply to call <code>register_gp_extension()</code>.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="writing-group-policy-extensions.html#cb111-1" aria-hidden="true" tabindex="-1"></a>ext_guid <span class="op">=</span> <span class="st">&#39;{5930022C-94FF-4ED5-A403-CFB4549DB6F0}&#39;</span></span>
<span id="cb111-2"><a href="writing-group-policy-extensions.html#cb111-2" aria-hidden="true" tabindex="-1"></a>ext_path <span class="op">=</span> os.path.realpath(<span class="va">__file__</span>)</span>
<span id="cb111-3"><a href="writing-group-policy-extensions.html#cb111-3" aria-hidden="true" tabindex="-1"></a>register_gp_extension(ext_guid, <span class="st">&#39;gp_scripts_ext&#39;</span>, ext_path,</span>
<span id="cb111-4"><a href="writing-group-policy-extensions.html#cb111-4" aria-hidden="true" tabindex="-1"></a>    smb_conf<span class="op">=</span><span class="st">&#39;/etc/samba/smb.conf&#39;</span>, machine<span class="op">=</span><span class="va">True</span>, user<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>The extension guid can be any random guid. It simply must be unique among all extensions that you register to the host. The extension path is literally just the path to the source file containing your CSE.</p>
<p>You must pass your smb.conf file to the extension, so it knows where to store the list of registered extensions. You also must specify whether to apply this extension to the machine, or to individual users (or to both).</p>
<p>Unregistering the extension is simple. You call the <code>unregister_gp_extension()</code> and pass it the unique guid you previously chose which represents this CSE.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="firewalld.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="regpol.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
