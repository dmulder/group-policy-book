# smb.conf Policies {#smbconf}

```{r, echo=FALSE, out.width="30%", fig.align='center'}
knitr::include_graphics("smb-conf-images/smbconf.png")
```

The purpose of the smb.conf policies is to be able to distribute smb.conf settings to Linux clients. This policy only supports a physical smb.conf file, and currently does not support smb.conf registry settings.

These policies are physically stored on the SYSVOL in the **MACHINE/Registry.pol** file in the subdirectory of the Group Policy Object. They are stored in registry format, and are difficult to modify manually. See chapter \@ref(regpol) for details on how to manually modify this file.

## Server Side Extension {#smbconf-sse}

The Server Side Extension for smb.conf policies is distributed using Administrative Templates (ADMX). Refer to chapter \@ref(sse) in section \@ref(admx) for details about Administrative Templates.

The smb.conf ADMX templates are distributed with the Samba binaries. Consult with your Samba maintainer as to where these templates are packaged. On openSUSE, for example, they are packaged in the samba-ad-dc package.

To install the smb.conf ADMX, you use the `samba-tool gpo admxload` command.

```
samba-tool gpo admxload --realm=REALM -UAdministrator --admx-dir=/usr/share/samba/admx
```

When running this command, you should be able to ommit the `--admx-dir` if the Samba ADMX templates are installed. You can also ommit the `--realm` option if the machine is joined to the domain.

### Managing smb.conf Policies via the GPME

After successfully installing the ADMX templates, open the Group Policy Management Editor (GPME) and navigate to `Computer Configuration > Policies > Administrative Templates > Samba > smb.conf`. For instructions on accessing the GPME, see chapter \@ref(manage) section \@ref(gpcreate).

![smb.conf Server Side Extension (ADMX)](smb-conf-images/gpme.png)

For this example, we're going to enable the `apply group policies` setting. This setting instructs Winbind to execute the `samba-gpupdate` command on the Group Policy interval (every 90 to 120 minutes). There are many other settings available here, but notice that idmap policies are not. That's because idmap policies modify the setting name (not just the value).

![apply group policies Setting](smb-conf-images/setting.png)

Apply the policy change, and close the GPME.

### Managing smb.conf Policies via samba-tool

Setting an smb.conf Group Policy via `samba-tool` is arguably much simpler.

```
> samba-tool gpo manage smb_conf set --help
Usage: samba-tool gpo manage smb_conf set <gpo> <setting> <value> [options]

Sets a Samba smb.conf Group Policy to the sysvol

This command sets an smb.conf setting to the sysvol for applying to winbind
clients. Not providing a value will unset the policy.

Example:
samba-tool gpo manage smb_conf set {31B2F340-016D-11D2-945F-00C04FB984F9}
'apply gpo policies' yes
```

This command does not require the ADMX templates to be installed, and also does not suffer from the same limitation as the GPME for idmap policies.

## Client Side Extension

The smb.conf Client Side Extension (CSE) directly modifies the default smb.conf file. Any custom formatting or comments in the smb.conf file may be overwritten. The CSE will open your existing smb.conf file, read in the current settings, set the settings provided by the GPO, then write the file back to disk. This CSE will only write `global` smb.conf options.

In the previous section, we enabled the `apply group policies` smb.conf option. If we now go to our Linux client, and check the Resultant Set of Policy, we see this:

```
> sudo /usr/sbin/samba-gpupdate --rsop
Resultant Set of Policy
Computer Policy

GPO: Default Domain Policy
=================================================================
  CSE: gp_smb_conf_ext
  -----------------------------------------------------------
    Policy Type: smb.conf
    -----------------------------------------------------------
    [ apply group policies ] = 1
    -----------------------------------------------------------
  -----------------------------------------------------------
=================================================================
```

If we now force the policy, we'll see our setting gets applied to the default smb.conf:

```
> sudo /usr/sbin/samba-gpupdate --force
> diff -u /etc/samba/smb.conf.BAK /etc/samba/smb.conf
--- /etc/samba/smb.conf.BAK
+++ /etc/samba/smb.conf
@@ -1,5 +1,6 @@
 # Global parameters
 [global]
+	apply group policies = Yes
 	kerberos method = secrets and keytab
 	logon drive = P:
 	logon home = \\%L\%U\.9xprofile
```

If for whatever reason the policy did not apply, it is sometimes helpful to look at the Group Policy Log, which keeps track of applied policies.

```
> sudo tdbdump /var/lib/samba/gpo.tdb -k "TESTSYSDM$" | sed -r "s/\\\22/\"/g" | xmllint --format -
<?xml version="1.0"?>
<gp>
  <user name="TESTSYSDM$">
    <guid value="{31B2F340-016D-11D2-945F-00C04FB984F9}">
      <gp_ext name="smb.conf">
        <attribute name="apply group policies">yes</attribute>
      </gp_ext>
    </guid>
    <applylog>
      <guid count="0" value="{31B2F340-016D-11D2-945F-00C04FB984F9}"/>
    </applylog>
  </user>
</gp>
```

Where **TESTSYSDM$** is the system name. You can see in our case Samba has recorded applying the Group Policy Object with GUID {31B2F340-016D-11D2-945F-00C04FB984F9} (this is the Default Domain Policy), and that it set `apply group policies = yes` in our smb.conf.
